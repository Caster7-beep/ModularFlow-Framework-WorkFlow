# æ­£åˆ™æ¨¡å— (`regex_module`) æ–‡æ¡£

æœ¬æ¨¡å—æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„ã€åŸºäºè§„åˆ™çš„æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢åŠŸèƒ½ï¼Œæ—¨åœ¨ä½œä¸ºå·¥ä½œæµä¸­çš„ä¸€ä¸ªå¯é‡ç”¨ç»„ä»¶ã€‚æ¨¡å—æ”¯æŒ**placementå­—æ®µ**æ¥åŒºåˆ†å®å¤„ç†å‰åçš„æ–‡æœ¬å¤„ç†æ—¶æœºã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

è¯¥æ¨¡å—çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ªå·²æ³¨å†Œçš„å‡½æ•° `apply_regex_rules`ï¼Œå®ƒèƒ½å¤Ÿæ ¹æ®ä¼ å…¥çš„ä¸€ç»„è§„åˆ™å¯¹æ–‡æœ¬è¿›è¡Œå¤„ç†ã€‚

### 1. `apply_regex_rules`

æ­¤å‡½æ•°æ¥æ”¶æ–‡æœ¬å’Œä¸€ç»„è§„åˆ™ï¼Œå¹¶æ ¹æ®è§„åˆ™ä¸­å®šä¹‰çš„æ¡ä»¶ï¼ˆå¦‚ `placement`, `views`, `targets` ç­‰ï¼‰æ¥å†³å®šæ˜¯å¦æ‰§è¡Œæ›¿æ¢ã€‚

-   **å‡½æ•°å**: `apply_regex_rules`
-   **æè¿°**: æ ¹æ®ä¼ å…¥çš„è§„åˆ™åˆ—è¡¨ï¼Œå¯¹æŒ‡å®šçš„æ–‡æœ¬æ‰§è¡Œæ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾å’Œæ›¿æ¢ã€‚

#### è¾“å…¥ (`inputs`)

| å‚æ•°å              | ç±»å‹                     | æè¿°                                                                                                   |
| :------------------ | :----------------------- | :----------------------------------------------------------------------------------------------------- |
| `before_macro_text` | `str`                    | **å¿…éœ€**ã€‚å®å¤„ç†å‰çš„åŸå§‹æ–‡æœ¬ã€‚                                                                         |
| `after_macro_text`  | `str`                    | **å¿…éœ€**ã€‚å®å¤„ç†åçš„æ–‡æœ¬ã€‚                                                                             |
| `rules`             | `List[Dict[str, Any]]`   | **å¿…éœ€**ã€‚ä¸€ä¸ªåŒ…å«æ­£åˆ™è§„åˆ™å¯¹è±¡çš„åˆ—è¡¨ã€‚æ¯ä¸ªè§„åˆ™çš„ç»“æ„è§ä¸‹æ–‡çš„ `RegexRule` æ•°æ®ç»“æ„ã€‚                   |
| `source_type`       | `str`                    | **å¿…éœ€**ã€‚å†…å®¹çš„æ¥æºç±»å‹ï¼Œç”¨äºä¸è§„åˆ™çš„ `targets` å­—æ®µè¿›è¡ŒåŒ¹é…ã€‚åˆæ³•å€¼è§ä¸‹æ–‡ `targets` å­—æ®µè¯´æ˜ã€‚      |
| `current_view`      | `str`                    | **å¿…éœ€**ã€‚å½“å‰è§†å›¾ï¼Œç”¨äºä¸è§„åˆ™çš„ `views` å­—æ®µåŒ¹é… (ä¾‹å¦‚, `'user_view'`, `'assistant_view'`)ã€‚        |
| `depth`             | `int`                    | (å¯é€‰)ã€‚å†…å®¹çš„æ·±åº¦ï¼Œç”¨äºèŒƒå›´åŒ¹é…ã€‚                                                                     |
| `order`             | `int`                    | (å¯é€‰)ã€‚å†…å®¹çš„æ¬¡åºï¼Œç”¨äºèŒƒå›´åŒ¹é…ã€‚                                                                     |

#### è¾“å‡º (`outputs`)

| å­—æ®µå           | ç±»å‹  | æè¿°             |
| :--------------- | :---- | :--------------- |
| `processed_text` | `str` | ç»è¿‡è§„åˆ™å¤„ç†åçš„æ–‡æœ¬ã€‚ |

## ğŸ“‹ `RegexRule` æ•°æ®ç»“æ„

ä¼ é€’ç»™ `rules` å‚æ•°çš„åˆ—è¡¨ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½åº”éµå¾ªä»¥ä¸‹ç»“æ„ï¼š

```json
{
  "id": "rule_unique_identifier",
  "name": "è§„åˆ™çš„å¯è¯»åç§°",
  "enabled": true,
  "find_regex": "è¦æŸ¥æ‰¾çš„æ­£åˆ™è¡¨è¾¾å¼",
  "replace_regex": "ç”¨äºæ›¿æ¢çš„å­—ç¬¦ä¸²æˆ–æ¨¡å¼",
  "targets": ["user", "assistant", "world_book"],
  "placement": "after_macro",
  "views": ["user_view", "assistant_view"],
  "min_depth": 1,
  "max_depth": 10,
  "min_order": 1,
  "max_order": 5,
  "description": "è§„åˆ™åŠŸèƒ½çš„ç®€è¦æè¿°",
  "enabled_expression": "{{python:getvar('enable_rule')}}"
}
```

### å­—æ®µè¯¦è§£

#### åŸºç¡€å­—æ®µ
-   **`id`** (`str`): è§„åˆ™çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
-   **`name`** (`str`): è§„åˆ™çš„å¯è¯»åç§°ã€‚
-   **`enabled`** (`bool`): è§„åˆ™æ˜¯å¦å¯ç”¨ã€‚
-   **`find_regex`** (`str`): ç”¨äºæŸ¥æ‰¾çš„æ­£åˆ™è¡¨è¾¾å¼ã€‚
-   **`replace_regex`** (`str`): ç”¨äºæ›¿æ¢çš„å­—ç¬¦ä¸²ï¼Œæ”¯æŒæ•è·ç»„å¼•ç”¨ (å¦‚ `$1`)ã€‚
-   **`description`** (`str`, å¯é€‰): è§„åˆ™çš„æè¿°ã€‚

#### ä½œç”¨åŸŸæ§åˆ¶
-   **`targets`** (`List[str]`): è§„åˆ™çš„ä½œç”¨å¯¹è±¡ã€‚åªæœ‰å½“ `source_type` å‚æ•°åœ¨æ­¤åˆ—è¡¨ä¸­æ—¶ï¼Œè§„åˆ™æ‰ä¼šç”Ÿæ•ˆã€‚
    -   **æƒå¨åˆ—è¡¨**: `["user", "assistant", "world_book", "preset", "assistant_thinking"]`
    
-   **`views`** (`List[str]`): ä½œç”¨è§†å›¾ã€‚åªæœ‰å½“ `current_view` å‚æ•°åœ¨æ­¤åˆ—è¡¨ä¸­æ—¶ï¼Œè§„åˆ™æ‰ä¼šæ‰§è¡Œæ›¿æ¢ã€‚
    -   **å¸¸ç”¨å€¼**: `["user_view", "assistant_view"]`

#### âš¡ å…³é”®ç‰¹æ€§ï¼šPlacement å­—æ®µ
-   **`placement`** (`str`): **å¤„ç†æ–‡æœ¬çš„é€‰æ‹©**ï¼Œè¿™æ˜¯æœ¬æ¨¡å—çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚
    -   **`"before_macro"`**: è§„åˆ™ä½œç”¨äº**å®å¤„ç†åçš„åŸå§‹æ–‡æœ¬** (`before_macro_text`)
    -   **`"after_macro"`**: è§„åˆ™ä½œç”¨äº**å½“å‰å¤„ç†è¿›åº¦çš„æ–‡æœ¬** (`processed_content`)
    -   **é»˜è®¤å€¼**: `"after_macro"`

**Placement å­—æ®µçš„å·¥ä½œåŸç†**ï¼š
- **æ ¸å¿ƒæ¦‚å¿µ**ï¼šæ‰€æœ‰æ­£åˆ™å¤„ç†éƒ½å‘ç”Ÿåœ¨å®å¤„ç†**å®Œæˆä¹‹å**ï¼Œå¤„ç†çš„æ˜¯æœ€ç»ˆçš„æ–‡æœ¬ç»“æœ
- **`"after_macro"`**ï¼ˆé»˜è®¤ï¼‰ï¼šè§„åˆ™å¤„ç†å®æ‰§è¡Œåäº§ç”Ÿçš„**æœ€ç»ˆæ–‡æœ¬**ï¼Œå®ç°**é“¾å¼å¤„ç†**
- **`"before_macro"`**ï¼šè§„åˆ™å¤„ç†ç»è¿‡ç‰¹æ®ŠåŒ…è£…çš„æ–‡æœ¬ï¼Œå³æŠŠå®çš„è¾“å‡ºé‡æ–°åŒ…è£…ä¸º `{{xxx}}` æ ¼å¼
- **å…³é”®åŒºåˆ«**ï¼š`"before_macro"` è®©æŸäº›è§„åˆ™èƒ½å¤Ÿçœ‹åˆ°å’Œå¤„ç† `{{xxx}}` å®è¯­æ³•æ ¼å¼ï¼Œè€Œéå®é™…çš„å®æ‰§è¡Œç»“æœ
- **ä½¿ç”¨åœºæ™¯**ï¼šå½“éœ€è¦å¯¹å®è¯­æ³•æœ¬èº«è¿›è¡Œå¤„ç†ï¼ˆå¦‚è½¬æ¢å®æ ¼å¼ã€ç§»é™¤ç‰¹å®šå®æ ‡è®°ç­‰ï¼‰è€Œä¸æ˜¯å¤„ç†å®çš„æ‰§è¡Œç»“æœæ—¶ï¼Œä½¿ç”¨ `"before_macro"`

#### èŒƒå›´é™åˆ¶
-   **`min_depth` / `max_depth`** (`int`, å¯é€‰): è§„åˆ™åº”ç”¨çš„æ·±åº¦èŒƒå›´ã€‚
-   **`min_order` / `max_order`** (`int`, å¯é€‰): è§„åˆ™åº”ç”¨çš„æ¬¡åºèŒƒå›´ã€‚

#### åŠ¨æ€æ§åˆ¶
-   **`enabled_expression`** (`Any`, å¯é€‰): åŠ¨æ€å¯ç”¨è¡¨è¾¾å¼ï¼Œæ”¯æŒå®è¡¨è¾¾å¼æ¥åŠ¨æ€æ§åˆ¶è§„åˆ™æ˜¯å¦å¯ç”¨ã€‚

## ğŸ—ï¸ æ¨¡å—æ¶æ„

### æ ¸å¿ƒç±»

#### 1. `RegexRule` (æ•°æ®ç±»)
è¡¨ç¤ºå•ä¸ªæ­£åˆ™è¡¨è¾¾å¼è§„åˆ™çš„æ•°æ®ç»“æ„ï¼ŒåŒ…å«æ‰€æœ‰è§„åˆ™é…ç½®ä¿¡æ¯ã€‚

#### 2. `RegexProcessor` (å¤„ç†å™¨)
æ­£åˆ™è¡¨è¾¾å¼è§„åˆ™çš„æ ¸å¿ƒå¤„ç†å™¨ï¼Œè´Ÿè´£ï¼š
- è§„åˆ™çš„åŠ è½½ã€ç¼–è¯‘å’Œæ’åº
- è§„åˆ™é€‚ç”¨æ€§çš„ç­›é€‰
- å®é™…çš„æ­£åˆ™è¡¨è¾¾å¼æ›¿æ¢æ‰§è¡Œ
- æ”¯æŒåŠ¨æ€å¯ç”¨è¡¨è¾¾å¼çš„è¯„ä¼°

### å¤„ç†æµç¨‹

1. **è§„åˆ™åŠ è½½**: ä»è§„åˆ™æ•°æ®ä¸­åˆ›å»º `RegexRule` å¯¹è±¡
2. **è§„åˆ™ç¼–è¯‘**: å°†æ­£åˆ™è¡¨è¾¾å¼é¢„ç¼–è¯‘ä»¥æé«˜æ€§èƒ½
3. **è§„åˆ™ç­›é€‰**: æ ¹æ® `source_type`, `depth`, `order` ç­‰æ¡ä»¶ç­›é€‰é€‚ç”¨çš„è§„åˆ™
4. **æ–‡æœ¬é€‰æ‹©**: æ ¹æ®è§„åˆ™çš„ `placement` å­—æ®µé€‰æ‹©è¦å¤„ç†çš„æ–‡æœ¬
5. **è§„åˆ™æ‰§è¡Œ**: æŒ‰é¡ºåºåº”ç”¨æ‰€æœ‰é€‚ç”¨çš„è§„åˆ™
6. **ç»“æœè¿”å›**: è¿”å›å¤„ç†åçš„æ–‡æœ¬

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1: åŸºæœ¬çš„å®åå¤„ç†
```python
# å‡è®¾ registry å·²ç»åˆå§‹åŒ–å¹¶åŠ è½½äº†æ¨¡å—
rules = [
    {
        "id": "remove_ids_for_user",
        "name": "ä¸ºç”¨æˆ·è§†å›¾éšè—å†…éƒ¨ID",
        "find_regex": "\\(id: \\d+\\)",
        "replace_regex": "",
        "targets": ["world_book"],
        "placement": "after_macro",  # åœ¨å®å¤„ç†åæ‰§è¡Œ
        "views": ["user_view"]
    }
]

before_text = "è¿™æ˜¯ä¸–ç•Œä¹¦æ¡ç›® (id: 123)ã€‚"
after_text = "è¿™æ˜¯ä¸–ç•Œä¹¦æ¡ç›® (id: 123)ã€‚{{getvar('processed')}}"

result = registry.call(
    "apply_regex_rules",
    before_macro_text=before_text,
    after_macro_text=after_text,
    rules=rules,
    source_type="world_book",
    current_view="user_view"
)
# result['processed_text'] å°†æ˜¯å»æ‰IDçš„æ–‡æœ¬
```

### ç¤ºä¾‹2: å®å‰é¢„å¤„ç†
```python
rules = [
    {
        "id": "preprocess_variables",
        "name": "é¢„å¤„ç†å˜é‡å¼•ç”¨",
        "find_regex": "\\$\\{(\\w+)\\}",
        "replace_regex": "{{getvar:'$1'}}",
        "targets": ["preset"],
        "placement": "before_macro",  # åœ¨å®å¤„ç†å‰æ‰§è¡Œ
        "views": ["assistant_view"]
    }
]

before_text = "è®¾ç½®å€¼ä¸º ${my_variable}"
after_text = "è®¾ç½®å€¼ä¸º some_processed_value"

result = registry.call(
    "apply_regex_rules",
    before_macro_text=before_text,
    after_macro_text=after_text,
    rules=rules,
    source_type="preset",
    current_view="assistant_view"
)
# è§„åˆ™ä¼šä½œç”¨äº before_macro_textï¼Œå°† ${my_variable} è½¬æ¢ä¸º {{getvar:'my_variable'}}
```

### ç¤ºä¾‹3: æ¡ä»¶æ€§è§„åˆ™æ‰§è¡Œ
```python
rules = [
    {
        "id": "conditional_rule",
        "name": "æ¡ä»¶æ€§æ›¿æ¢è§„åˆ™",
        "enabled_expression": "{{python:getvar('enable_formatting')}}",
        "find_regex": "\\*\\*(.*?)\\*\\*",
        "replace_regex": "<strong>$1</strong>",
        "targets": ["assistant"],
        "placement": "after_macro",
        "views": ["user_view"]
    }
]

# è§„åˆ™åªæœ‰åœ¨ enable_formatting å˜é‡ä¸ºçœŸæ—¶æ‰ä¼šæ‰§è¡Œ
```

### ç¤ºä¾‹4: åŒè§†å›¾å¤„ç†
```python
rules = [
    {
        "id": "user_view_rule",
        "name": "ç”¨æˆ·è§†å›¾ç¾åŒ–",
        "find_regex": "\\[DEBUG\\].*?\\n",
        "replace_regex": "",
        "targets": ["assistant"],
        "placement": "after_macro",
        "views": ["user_view"]  # åªåœ¨ç”¨æˆ·è§†å›¾ä¸­ç§»é™¤è°ƒè¯•ä¿¡æ¯
    },
    {
        "id": "ai_view_rule", 
        "name": "AIè§†å›¾å¢å¼º",
        "find_regex": "^(.*)$",
        "replace_regex": "[CONTEXT] $1",
        "targets": ["world_book"],
        "placement": "after_macro", 
        "views": ["assistant_view"]  # åªåœ¨AIè§†å›¾ä¸­æ·»åŠ ä¸Šä¸‹æ–‡æ ‡è®°
    }
]

# ç›¸åŒçš„å†…å®¹ä¼šæ ¹æ®ä¸åŒçš„è§†å›¾äº§ç”Ÿä¸åŒçš„è¾“å‡º
```

## ğŸ”§ æ€§èƒ½ä¼˜åŒ–

### è§„åˆ™ç¼–è¯‘
- æ‰€æœ‰æ­£åˆ™è¡¨è¾¾å¼åœ¨åˆå§‹åŒ–æ—¶é¢„ç¼–è¯‘ï¼Œé¿å…é‡å¤ç¼–è¯‘å¼€é”€
- å¤±è´¥çš„æ­£åˆ™è¡¨è¾¾å¼ä¼šè¢«è·³è¿‡ï¼Œä¸å½±å“å…¶ä»–è§„åˆ™çš„æ‰§è¡Œ

### è§„åˆ™ç­›é€‰
- å¤šå±‚ç­›é€‰æœºåˆ¶ï¼Œåªå¤„ç†é€‚ç”¨çš„è§„åˆ™
- æŒ‰ç›®æ ‡æ•°é‡å’ŒIDæ’åºï¼Œä¼˜åŒ–åŒ¹é…æ•ˆç‡

### é”™è¯¯å¤„ç†
- å•ä¸ªè§„åˆ™çš„é”™è¯¯ä¸ä¼šå½±å“å…¶ä»–è§„åˆ™çš„æ‰§è¡Œ
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—å¸®åŠ©è°ƒè¯•å’Œç»´æŠ¤

## ğŸ” è°ƒè¯•æ”¯æŒ

### æ—¥å¿—ä¿¡æ¯
- è§„åˆ™ç¼–è¯‘æˆåŠŸ/å¤±è´¥çŠ¶æ€
- è§„åˆ™ç­›é€‰å’ŒåŒ¹é…è¿‡ç¨‹
- å®é™…çš„æ›¿æ¢æ‰§è¡Œç»“æœ
- è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå †æ ˆè·Ÿè¸ª

### è§„åˆ™éªŒè¯
- è‡ªåŠ¨æ£€æµ‹å’ŒæŠ¥å‘Šæ— æ•ˆçš„æ­£åˆ™è¡¨è¾¾å¼
- è§„åˆ™é…ç½®å®Œæ•´æ€§æ£€æŸ¥
- è¿è¡Œæ—¶åŠ¨æ€å¯ç”¨è¡¨è¾¾å¼çš„è¯„ä¼°

## ğŸš€ æ‰©å±•å¼€å‘

### è‡ªå®šä¹‰è§„åˆ™ç±»å‹
é€šè¿‡ç»§æ‰¿ `RegexRule` ç±»æ·»åŠ æ–°çš„è§„åˆ™ç±»å‹ï¼š

```python
@dataclass
class CustomRegexRule(RegexRule):
    custom_field: str = ""
    # æ·»åŠ è‡ªå®šä¹‰å­—æ®µå’Œé€»è¾‘
```

### è‡ªå®šä¹‰å¤„ç†å™¨
ç»§æ‰¿ `RegexProcessor` ç±»å®ç°ç‰¹æ®Šçš„å¤„ç†é€»è¾‘ï¼š

```python
class CustomRegexProcessor(RegexProcessor):
    def _filter_applicable_rules(self, source_type, depth, order):
        # å®ç°è‡ªå®šä¹‰çš„è§„åˆ™ç­›é€‰é€»è¾‘
        pass
```

### å®è¡¨è¾¾å¼é›†æˆ
æ¨¡å—è‡ªåŠ¨é›†æˆå®å¤„ç†å™¨æ¥è¯„ä¼°åŠ¨æ€å¯ç”¨è¡¨è¾¾å¼ï¼Œæ”¯æŒå¤æ‚çš„æ¡ä»¶é€»è¾‘ã€‚