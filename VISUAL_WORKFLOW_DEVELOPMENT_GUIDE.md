# å¯è§†åŒ–å·¥ä½œæµç³»ç»Ÿå¼€å‘æŒ‡å—

> **ç‰ˆæœ¬ï¼š** v1.0  
> **æœ€åæ›´æ–°ï¼š** 2025-01-17  
> **é¡¹ç›®ï¼š** ModularFlow Framework - å¯è§†åŒ–å·¥ä½œæµå¼•æ“

## ğŸ“‘ ç›®å½•

- [1. é¡¹ç›®æ¦‚è¿°å’Œç›®æ ‡](#1-é¡¹ç›®æ¦‚è¿°å’Œç›®æ ‡)
- [2. å®Œæ•´æ¶æ„è®¾è®¡](#2-å®Œæ•´æ¶æ„è®¾è®¡)
- [3. æ•°æ®æµæœºåˆ¶è®¾è®¡](#3-æ•°æ®æµæœºåˆ¶è®¾è®¡)
- [4. å‰ç«¯å¯è§†åŒ–ç¼–è¾‘å™¨è®¾è®¡](#4-å‰ç«¯å¯è§†åŒ–ç¼–è¾‘å™¨è®¾è®¡)
- [5. è¯¦ç»†å®ç°è§„èŒƒ](#5-è¯¦ç»†å®ç°è§„èŒƒ)
- [6. å…¼å®¹æ€§åˆ†æ](#6-å…¼å®¹æ€§åˆ†æ)
- [7. å¼€å‘è·¯çº¿å›¾](#7-å¼€å‘è·¯çº¿å›¾)
- [8. æŠ€æœ¯æ ˆå’Œä¾èµ–æ¸…å•](#8-æŠ€æœ¯æ ˆå’Œä¾èµ–æ¸…å•)
- [9. å¼€å‘æ£€æŸ¥æ¸…å•](#9-å¼€å‘æ£€æŸ¥æ¸…å•)

---

## 1. é¡¹ç›®æ¦‚è¿°å’Œç›®æ ‡

### ğŸ¯ é¡¹ç›®æ„¿æ™¯

åˆ›å»ºä¸€ä¸ªä¾¿äºä½¿ç”¨çš„å¯è§†åŒ–å·¥ä½œæµç¼–æ’å¹³å°ï¼Œæ”¯æŒå¤šLLMååŒå·¥ä½œï¼Œé€šè¿‡æ‹–æ‹½å¼ç•Œé¢è®©ç”¨æˆ·èƒ½å¤Ÿè½»æ¾æ„å»ºå¤æ‚çš„LLMååŒæµç¨‹ï¼Œå®ç°é«˜çº§çš„AIå¯¹è¯å’Œå¤„ç†èƒ½åŠ›ã€‚

### æ ¸å¿ƒç›®æ ‡

1. **å¯è§†åŒ–ç¼–æ’**: æä¾›ç›´è§‚çš„æ‹–æ‹½å¼ç•Œé¢ï¼Œè®©ç”¨æˆ·æ— éœ€ç¼–ç¨‹å³å¯åˆ›å»ºå¤æ‚å·¥ä½œæµ
2. **å¤šLLMååŒ**: æ”¯æŒä¸åŒLLMæä¾›å•†ï¼ˆOpenAIã€Anthropicã€Geminiï¼‰çš„ååŒå·¥ä½œ
3. **æ¡ä»¶åˆ†æ”¯**: æ”¯æŒåŸºäºLLMè¾“å‡ºçš„åŠ¨æ€è·¯å¾„é€‰æ‹©å’Œæ¡ä»¶æ‰§è¡Œ
4. **ä»£ç å—æ”¯æŒ**: å…è®¸æ’å…¥è‡ªå®šä¹‰é€»è¾‘å¤„ç†èŠ‚ç‚¹
5. **å®æ—¶ç›‘æ§**: æä¾›å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€çš„å®æ—¶å¯è§†åŒ–
6. **æ¨¡æ¿ç³»ç»Ÿ**: æä¾›é¢„è®¾çš„å¸¸ç”¨å·¥ä½œæµæ¨¡æ¿

### åº”ç”¨åœºæ™¯

- **æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ**: å¤šè½®å¯¹è¯ä¸­çš„æ„å›¾è¯†åˆ«å’Œè·¯å¾„åˆ†å‘
- **å†…å®¹å¤„ç†**: æ–‡æ¡£åˆ†æã€æ‘˜è¦ç”Ÿæˆã€å¤šè¯­è¨€ç¿»è¯‘
- **å†³ç­–æ”¯æŒ**: åŸºäºå¤šä¸ªAIæ¨¡å‹çš„ç»¼åˆå†³ç­–
- **æ‰¹é‡å¤„ç†**: å¤§è§„æ¨¡æ•°æ®çš„æ™ºèƒ½å¤„ç†å’Œåˆ†æ

### æ ¸å¿ƒç‰¹æ€§

- âœ… **é›¶ä»£ç ç¼–æ’**: æ‹–æ‹½å¼ç•Œé¢ï¼Œæ— éœ€ç¼–ç¨‹æŠ€èƒ½
- âœ… **å¤šæä¾›å•†æ”¯æŒ**: OpenAIã€Anthropicã€Geminiç­‰
- âœ… **æ¡ä»¶åˆ†æ”¯**: åŸºäºAIè¾“å‡ºçš„åŠ¨æ€æµç¨‹æ§åˆ¶
- âœ… **å®æ—¶æ‰§è¡Œ**: æ”¯æŒå·¥ä½œæµçš„å®æ—¶ç›‘æ§å’Œè°ƒè¯•
- âœ… **æ¨¡æ¿åº“**: é¢„è®¾å¸¸ç”¨å·¥ä½œæµæ¨¡æ¿
- âœ… **å®Œå…¨å…¼å®¹**: ä¸ç°æœ‰ModularFlow Frameworkæ— ç¼é›†æˆ

---

## 2. å®Œæ•´æ¶æ„è®¾è®¡

### ğŸ—ï¸ æ•´ä½“æ¶æ„

#### é¡¹ç›®æ¨¡å—ç»„ç»‡

åŸºäºModularFlowæ¡†æ¶çš„æ¨¡å—åŒ–è®¾è®¡åŸåˆ™ï¼š

```
ModularFlow-Framework/
â”œâ”€â”€ modules/                          # é€šç”¨æ¨¡å—
â”‚   â”œâ”€â”€ visual_workflow_module/       # ğŸ†• å¯è§†åŒ–å·¥ä½œæµæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ visual_workflow_module.py # APIæ¥å£
â”‚   â”‚   â”œâ”€â”€ workflow_engine.py        # æ ¸å¿ƒå¼•æ“
â”‚   â”‚   â”œâ”€â”€ node_types.py            # èŠ‚ç‚¹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ workflow_manager.py      # å·¥ä½œæµç®¡ç†
â”‚   â”‚   â”œâ”€â”€ execution_monitor.py     # æ‰§è¡Œç›‘æ§
â”‚   â”‚   â””â”€â”€ README.md
â”‚   â”‚
â”‚   â”œâ”€â”€ api_gateway_module/          # âœ… ç°æœ‰APIç½‘å…³
â”‚   â”œâ”€â”€ llm_api_module/             # âœ… ç°æœ‰LLM API
â”‚   â””â”€â”€ web_server_module/          # âœ… ç°æœ‰WebæœåŠ¡
â”‚
â”œâ”€â”€ orchestrators/                   # å·¥ä½œæµç¼–æ’å™¨
â”‚   â”œâ”€â”€ simple_workflow.py         # âœ… åŸºç¡€å·¥ä½œæµ
â”‚   â””â”€â”€ visual_workflow.py         # ğŸ†• å¯è§†åŒ–å·¥ä½œæµå¼•æ“
â”‚
â”œâ”€â”€ frontend_projects/              # å‰ç«¯é¡¹ç›®
â”‚   â”œâ”€â”€ visual_workflow_editor/     # ğŸ†• å¯è§†åŒ–ç¼–è¾‘å™¨
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ components/        # Reactç»„ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ services/          # APIæœåŠ¡
â”‚   â”‚   â”‚   â””â”€â”€ utils/             # å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ public/
â”‚   â”‚
â”‚   â””â”€â”€ SmartTavern/               # âœ… ç°æœ‰é¡¹ç›®
â””â”€â”€ workflows/                     # å·¥ä½œæµå­˜å‚¨
```

#### ç³»ç»Ÿæ¶æ„å±‚æ¬¡

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        A[å¯è§†åŒ–ç¼–è¾‘å™¨] --> B[React Flow Canvas]
        A --> C[èŠ‚ç‚¹é…ç½®é¢æ¿]
        A --> D[å±æ€§ç¼–è¾‘å™¨]
    end
    
    subgraph "APIå±‚"
        E[API Gateway] --> F[RESTæ¥å£]
        E --> G[WebSocketæ¥å£]
    end
    
    subgraph "ä¸šåŠ¡é€»è¾‘å±‚"
        H[å¯è§†åŒ–å·¥ä½œæµæ¨¡å—] --> I[å·¥ä½œæµç®¡ç†å™¨]
        H --> J[èŠ‚ç‚¹å·¥å‚]
        H --> K[æ‰§è¡Œç›‘æ§å™¨]
    end
    
    subgraph "æ‰§è¡Œå¼•æ“å±‚"
        L[å¯è§†åŒ–å·¥ä½œæµå¼•æ“] --> M[èŠ‚ç‚¹æ³¨å†Œå™¨]
        L --> N[è¿æ¥ç®¡ç†å™¨]
        L --> O[æ‰§è¡Œè°ƒåº¦å™¨]
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚"
        P[SimpleWorkflow] --> Q[å‡½æ•°æ³¨å†Œè¡¨]
        P --> R[LLM APIæ¨¡å—]
        P --> S[æ•°æ®æµç®¡ç†]
    end
    
    A --> E
    E --> H
    H --> L
    L --> P
```

### ğŸ”§ æ¨¡å—æ¶æ„è®¾è®¡

#### æ•°æ®è§„èŒƒç®€åŒ–

é‡‡ç”¨é¢å‘LLMäº¤äº’çš„ç®€åŒ–æ•°æ®ç±»å‹ï¼š

```typescript
// ç®€åŒ–çš„æ•°æ®ç±»å‹
type WorkflowData = string | number | boolean | {
  text: string           // ä¸»è¦å†…å®¹ (LLMè¾“å…¥/è¾“å‡º)
  metadata?: any        // å¯é€‰å…ƒæ•°æ®
}

// èŠ‚ç‚¹è¾“å‡ºæ ‡å‡†
interface NodeOutput {
  text: string          // LLMçš„æ–‡æœ¬è¾“å‡º (ä¸»è¦æ•°æ®)
  signal?: number       // æ§åˆ¶ä¿¡å· (æ¡ä»¶åˆ†æ”¯ç”¨)
  confidence?: number   // ç½®ä¿¡åº¦ (å¯é€‰)
  metadata?: any        // å…ƒæ•°æ® (è°ƒè¯•ã€æ—¥å¿—ç­‰)
}
```

#### èŠ‚ç‚¹ç±»å‹å®šä¹‰

```python
class NodeType(Enum):
    INPUT = "input"                    # è¾“å…¥èŠ‚ç‚¹
    LLM_CALL = "llm_call"             # LLMè°ƒç”¨èŠ‚ç‚¹
    CODE_BLOCK = "code_block"         # ä»£ç å—èŠ‚ç‚¹
    CONDITION = "condition"           # æ¡ä»¶åˆ¤æ–­èŠ‚ç‚¹
    SWITCH = "switch"                 # å¼€å…³è·¯ç”±èŠ‚ç‚¹
    MERGER = "merger"                 # ç»“æœèšåˆèŠ‚ç‚¹
    OUTPUT = "output"                 # è¾“å‡ºèŠ‚ç‚¹
```

#### è¿æ¥é…ç½®ç®€åŒ–

```typescript
interface Connection {
  source: string
  target: string
  dataType: 'text' | 'signal' | 'all'    // ç®€åŒ–çš„æ•°æ®ç±»å‹
  condition?: string                       // å¯é€‰çš„æ¡ä»¶è¡¨è¾¾å¼
}
```

---

## 3. æ•°æ®æµæœºåˆ¶è®¾è®¡

### ğŸ” ç°æœ‰æœºåˆ¶åˆ†æ

#### SimpleWorkflowæ•°æ®ä¼ é€’æœºåˆ¶

åŸºäº[`SimpleWorkflow.execute()`](orchestrators/simple_workflow.py:145)çš„æ ¸å¿ƒé€»è¾‘ï¼š

```python
# æ•°æ®ä¼ é€’æ ¸å¿ƒæœºåˆ¶
for conn in self.connections:
    if conn.to_func == func_name and conn.from_func in self.results:
        from_result = self.results[conn.from_func]
        if isinstance(from_result, dict) and conn.from_output in from_result:
            inputs[conn.to_input] = from_result[conn.from_output]
```

#### ç°æœ‰æœºåˆ¶ç‰¹ç‚¹

1. **å­—å…¸é”®å€¼ä¼ é€’**: æ‰€æœ‰å‡½æ•°ç»“æœå¿…é¡»æ˜¯dictï¼Œé€šè¿‡keyè®¿é—®ç‰¹å®šå€¼
2. **é™æ€è¿æ¥**: è¿æ¥å…³ç³»åœ¨æ‰§è¡Œå‰ç¡®å®šï¼Œæ— æ³•åŠ¨æ€ä¿®æ”¹
3. **ç®€å•æ˜ å°„**: `FlowConnection`åªæ”¯æŒ1:1çš„å­—æ®µæ˜ å°„
4. **åŒæ­¥æ‰§è¡Œ**: è™½ç„¶æœ‰asyncç‰ˆæœ¬ï¼Œä½†æ¡ä»¶åˆ†æ”¯é€»è¾‘æ˜¯çº¿æ€§çš„

### ğŸ’¡ å¢å¼ºå‹æ•°æ®ä¼ é€’æœºåˆ¶

#### 1. å¢å¼ºè¿æ¥å®šä¹‰

```python
@dataclass
class EnhancedFlowConnection:
    """å¢å¼ºå‹æ•°æ®æµè¿æ¥"""
    from_func: str
    from_output: str
    to_func: str  
    to_input: str
    
    # æ–°å¢å­—æ®µ
    condition: Optional[str] = None      # æ¡ä»¶è¡¨è¾¾å¼
    transform: Optional[str] = None      # æ•°æ®è½¬æ¢é€»è¾‘
    data_selector: Optional[Dict] = None # åŠ¨æ€æ•°æ®é€‰æ‹©
```

#### 2. æ¡ä»¶æ‰§è¡Œå¼•æ“

```python
class ConditionalWorkflow(SimpleWorkflow):
    """æ”¯æŒæ¡ä»¶åˆ†æ”¯çš„å·¥ä½œæµå¼•æ“"""
    
    def __init__(self):
        super().__init__()
        self.conditional_connections = []  # æ¡ä»¶è¿æ¥
        self.data_context = {}            # å…¨å±€æ•°æ®ä¸Šä¸‹æ–‡
    
    def add_condition_node(self, node_id: str, condition_logic: str):
        """æ·»åŠ æ¡ä»¶åˆ¤æ–­èŠ‚ç‚¹"""
        def condition_func(**inputs):
            # æ‰§è¡Œæ¡ä»¶é€»è¾‘ï¼Œè¿”å›åˆ†æ”¯é€‰æ‹©
            return {"branch": eval_condition(condition_logic, inputs, self.data_context)}
        
        self.registry.register(node_id, condition_func, ['input'], ['branch'])
    
    def add_switch_connection(self, from_func: str, condition_map: Dict):
        """æ·»åŠ æ¡ä»¶åˆ†æ”¯è¿æ¥"""
        # condition_map: {branch_value: target_func}
        self.conditional_connections.append({
            'from_func': from_func,
            'condition_map': condition_map
        })
```

#### 3. ä»£ç å—èŠ‚ç‚¹å®ç°

```python
def create_code_block_node(node_id: str, code: str, context_vars: Dict = None):
    """åˆ›å»ºä»£ç å—èŠ‚ç‚¹"""
    
    def code_block_func(**inputs):
        # åˆ›å»ºæ‰§è¡Œç¯å¢ƒ
        exec_context = {
            'inputs': inputs,
            'context': context_vars or {},
            'utils': {  # æä¾›å·¥å…·å‡½æ•°
                'select_data': lambda key, data_map: data_map.get(key),
                'format_prompt': lambda template, **kwargs: template.format(**kwargs)
            }
        }
        
        # æ‰§è¡Œç”¨æˆ·ä»£ç 
        exec(code, exec_context)
        
        # è¿”å›ç»“æœ
        return exec_context.get('outputs', {})
    
    return code_block_func
```

### ğŸš€ å…·ä½“åº”ç”¨ç¤ºä¾‹

#### å¤šLLMåˆ¤æ–­ä¸æ¡ä»¶åˆ†æ”¯

```python
# åˆ›å»ºå·¥ä½œæµ
wf = ConditionalWorkflow("multi_llm_decision")

# 1. LLM-A: åˆ¤æ–­èŠ‚ç‚¹
wf.add_llm_node("llm_judge", {
    "prompt": "æ ¹æ®è¾“å…¥æ–‡æœ¬åˆ¤æ–­åº”è¯¥è°ƒç”¨å“ªç§è¯­æ–™å¤„ç†æ–¹å¼ï¼Œè¿”å›1,2,3ä¸­çš„ä¸€ä¸ªæ•°å­—",
    "provider": "gemini"
})

# 2. ä»£ç å—: åŠ¨æ€è¯­æ–™é€‰æ‹©
language_selector_code = """
judge_result = inputs['response']['content']
choice = int(judge_result.strip())

language_corpus = {
    1: "æ­£å¼å•†åŠ¡è¯­æ–™åº“",
    2: "æ—¥å¸¸å¯¹è¯è¯­æ–™åº“", 
    3: "æŠ€æœ¯æ–‡æ¡£è¯­æ–™åº“"
}

outputs = {
    'selected_corpus': language_corpus.get(choice, language_corpus[1]),
    'choice': choice
}
"""
wf.add_code_block("language_selector", language_selector_code)

# 3. SwitchèŠ‚ç‚¹: è·¯å¾„é€‰æ‹©
wf.add_condition_node("path_switch", "inputs['choice']")

# 4. ä¸åŒçš„LLMå¤„ç†èŠ‚ç‚¹
wf.add_llm_node("llm_formal", {"prompt": "ä½¿ç”¨æ­£å¼è¯­è°ƒå¤„ç†: {corpus}", "provider": "openai"})
wf.add_llm_node("llm_casual", {"prompt": "ä½¿ç”¨æ—¥å¸¸è¯­è°ƒå¤„ç†: {corpus}", "provider": "anthropic"})

# 5. å»ºç«‹è¿æ¥
wf.connect("llm_judge", "language_selector", {"response": "response"})
wf.connect("language_selector", "path_switch", {"choice": "choice"})

# 6. æ¡ä»¶åˆ†æ”¯è¿æ¥
wf.add_switch_connection("path_switch", {
    1: "llm_formal",
    2: "llm_casual", 
    3: ["llm_formal", "llm_casual"]  # å¹¶è¡Œæ‰§è¡Œ
})
```

### ğŸ“Š æ•°æ®æµè¿½è¸ª

```python
class DataFlowTracker:
    """æ•°æ®æµè¿½è¸ªå™¨"""
    
    def __init__(self):
        self.flow_log = []
        
    def log_data_transfer(self, from_node, to_node, data, condition=None):
        self.flow_log.append({
            'timestamp': time.time(),
            'from': from_node,
            'to': to_node, 
            'data': data,
            'condition': condition
        })
    
    def get_flow_visualization(self):
        """ç”Ÿæˆæ•°æ®æµå¯è§†åŒ–"""
        return self.flow_log
```

---

## 4. å‰ç«¯å¯è§†åŒ–ç¼–è¾‘å™¨è®¾è®¡

### ğŸ¨ æ•´ä½“ç•Œé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å·¥ä½œæµç¼–è¾‘å™¨                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                     â”‚                 â”‚
â”‚ èŠ‚ç‚¹é¢æ¿  â”‚              ä¸»ç”»å¸ƒåŒºåŸŸ                â”‚   å±æ€§é…ç½®é¢æ¿    â”‚
â”‚ (200px) â”‚            (è‡ªé€‚åº”)                  â”‚    (300px)     â”‚
â”‚         â”‚                                     â”‚                 â”‚
â”‚ ğŸ“ LLM  â”‚  â”Œâ”€â”€â”€ ç”¨æˆ·è¾“å…¥ â”€â”€â”€â”                   â”‚ â”Œâ”€ èŠ‚ç‚¹é…ç½® â”€â”  â”‚
â”‚ ğŸ”§ ä»£ç å— â”‚  â”‚              â”‚                   â”‚ â”‚ æä¾›å•†:    â”‚  â”‚
â”‚ âš¡ æ¡ä»¶  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚ â”‚ [Geminiâ–¼] â”‚  â”‚
â”‚ ğŸ¯ èšåˆ  â”‚         â”‚                           â”‚ â”‚           â”‚  â”‚
â”‚ ğŸ“¤ è¾“å‡º  â”‚         â–¼                           â”‚ â”‚ æ¨¡å‹:     â”‚  â”‚
â”‚         â”‚  â”Œâ”€â”€â”€ LLMåˆ†æ â”€â”€â”€â”                   â”‚ â”‚ [2.5-flash]â”‚  â”‚
â”‚ + è‡ªå®šä¹‰ â”‚  â”‚ ğŸ¤– [Gemini]   â”‚â”€â”€â”                â”‚ â”‚           â”‚  â”‚
â”‚         â”‚  â”‚ "åˆ¤æ–­ç”¨æˆ·æ„å›¾" â”‚  â”‚                â”‚ â”‚ æç¤ºè¯:   â”‚  â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                â”‚ â”‚ [ç¼–è¾‘å™¨]  â”‚  â”‚
â”‚         â”‚         â”‚           â”‚                â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚         â–¼           â–¼                â”‚                 â”‚
â”‚         â”‚  â”Œâ”€â”€â”€ æ¡ä»¶åˆ†æ”¯ â”€â”€â”€â” â”Œâ”€â”€â”€ æƒ…æ„Ÿåˆ†æ â”€â”€â”€â” â”‚ â”Œâ”€ æ‰§è¡ŒçŠ¶æ€ â”€â”  â”‚
â”‚         â”‚  â”‚ âš¡ Switch     â”‚ â”‚ ğŸ¤– [Claude]    â”‚ â”‚ â”‚ â¸ï¸ å·²æš‚åœ  â”‚  â”‚
â”‚         â”‚  â”‚ signal â†’ path â”‚ â”‚ "åˆ†ææƒ…æ„Ÿå€¾å‘"  â”‚ â”‚ â”‚ è¿›åº¦: 2/5  â”‚  â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ è¿è¡Œæ—¶é—´:  â”‚  â”‚
â”‚         â”‚         â”‚                           â”‚ â”‚ 00:01:23   â”‚  â”‚
â”‚         â”‚         â–¼                           â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚  â”Œâ”€â”€â”€ ç»“æœèšåˆ â”€â”€â”€â”                  â”‚                 â”‚
â”‚         â”‚  â”‚ ğŸ¯ Merge      â”‚                  â”‚ â”Œâ”€ æµç¨‹æ§åˆ¶ â”€â”  â”‚
â”‚         â”‚  â”‚ "æ•´åˆåˆ†æç»“æœ" â”‚                  â”‚ â”‚ â–¶ï¸ æ‰§è¡Œ    â”‚  â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚ â¸ï¸ æš‚åœ    â”‚  â”‚
â”‚         â”‚         â”‚                           â”‚ â”‚ ğŸ”„ é‡ç½®    â”‚  â”‚
â”‚         â”‚         â–¼                           â”‚ â”‚ ğŸ’¾ ä¿å­˜    â”‚  â”‚
â”‚         â”‚  â”Œâ”€â”€â”€ æœ€ç»ˆè¾“å‡º â”€â”€â”€â”                  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚  â”‚ ğŸ“¤ Output     â”‚                  â”‚                 â”‚
â”‚         â”‚  â”‚ "æ˜¾ç¤ºç»™ç”¨æˆ·"   â”‚                  â”‚                 â”‚
â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚                 â”‚
â”‚         â”‚                                     â”‚                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åº•éƒ¨çŠ¶æ€æ : å·¥ä½œæµ: "ç”¨æˆ·æ„å›¾åˆ†æ" | èŠ‚ç‚¹: 6 | è¿æ¥: 5 | æœ€åä¿å­˜: 2åˆ†é’Ÿå‰ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ§© èŠ‚ç‚¹è®¾è®¡è§„èŒƒ

#### èŠ‚ç‚¹è§†è§‰æ ·å¼

```css
/* åŸºç¡€èŠ‚ç‚¹æ ·å¼ */
.workflow-node {
  width: 160px;
  min-height: 80px;
  border-radius: 8px;
  border: 2px solid #ddd;
  background: white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  position: relative;
  cursor: move;
}

/* èŠ‚ç‚¹ç±»å‹æ ·å¼ */
.node-llm { border-color: #4CAF50; }      /* ç»¿è‰² - LLMèŠ‚ç‚¹ */
.node-code { border-color: #FF9800; }     /* æ©™è‰² - ä»£ç å— */
.node-condition { border-color: #2196F3; } /* è“è‰² - æ¡ä»¶èŠ‚ç‚¹ */
.node-merge { border-color: #9C27B0; }    /* ç´«è‰² - èšåˆèŠ‚ç‚¹ */
.node-output { border-color: #607D8B; }   /* ç°è‰² - è¾“å‡ºèŠ‚ç‚¹ */

/* æ‰§è¡ŒçŠ¶æ€ */
.node-running { border-color: #FFC107; animation: pulse 1s infinite; }
.node-completed { border-color: #4CAF50; }
.node-error { border-color: #F44336; }
```

#### LLMèŠ‚ç‚¹è¯¦ç»†è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– LLMè°ƒç”¨         â”‚ â† èŠ‚ç‚¹æ ‡é¢˜
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Provider: Gemini   â”‚ â† å…³é”®é…ç½®æ˜¾ç¤º
â”‚ Model: 2.5-flash   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ "åˆ¤æ–­ç”¨æˆ·è¾“å…¥çš„æ„å›¾  â”‚ â† æç¤ºè¯é¢„è§ˆ
â”‚ åˆ†ç±»ä¸º: å’¨è¯¢ã€æŠ•è¯‰ã€ â”‚   (æˆªæ–­æ˜¾ç¤º)
â”‚ å»ºè®®..."           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â— text_in         â”‚ â† è¾“å…¥ç«¯å£
â”‚                 â—  â”‚ â† è¾“å‡ºç«¯å£ text_out
â”‚               â—‹    â”‚ â† è¾“å‡ºç«¯å£ signal
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”— è¿æ¥çº¿è®¾è®¡

#### è¿æ¥çº¿ç±»å‹ä¸çŠ¶æ€

```typescript
interface ConnectionStyle {
  type: 'data' | 'control'
  
  // æ•°æ®è¿æ¥ - å®çº¿
  data: {
    color: '#666',
    width: 2,
    style: 'solid'
  }
  
  // æ§åˆ¶è¿æ¥ - è™šçº¿  
  control: {
    color: '#2196F3',
    width: 2,
    style: 'dashed'
  }
}
```

#### è¿æ¥çŠ¶æ€å¯è§†åŒ–

```css
/* è¿æ¥çº¿çŠ¶æ€ */
.connection-normal { stroke: #666; }
.connection-active { stroke: #4CAF50; animation: flow 2s linear infinite; }
.connection-error { stroke: #F44336; }

/* æ•°æ®æµåŠ¨ç”» */
@keyframes flow {
  0% { stroke-dasharray: 5 5; stroke-dashoffset: 0; }
  100% { stroke-dashoffset: 10; }
}
```

### ğŸ› ï¸ èŠ‚ç‚¹é…ç½®ç•Œé¢

#### LLMèŠ‚ç‚¹é…ç½®

```typescript
interface LLMNodeConfigUI {
  sections: [
    {
      title: "åŸºç¡€é…ç½®",
      fields: [
        {
          label: "èŠ‚ç‚¹åç§°",
          type: "text",
          value: "LLMåˆ†æ"
        },
        {
          label: "LLMæä¾›å•†",
          type: "select", 
          options: ["OpenAI", "Anthropic", "Gemini"],
          value: "Gemini"
        },
        {
          label: "æ¨¡å‹",
          type: "select",
          options: ["gpt-4", "claude-3", "gemini-2.5-flash"],
          value: "gemini-2.5-flash"
        }
      ]
    },
    {
      title: "æç¤ºè¯é…ç½®", 
      fields: [
        {
          label: "ç³»ç»Ÿæç¤ºè¯",
          type: "textarea",
          placeholder: "è®¾å®šAIçš„è§’è‰²å’Œè¡Œä¸º..."
        },
        {
          label: "ç”¨æˆ·æç¤ºè¯",
          type: "code-editor",  // æ”¯æŒå˜é‡é«˜äº®
          value: "è¯·åˆ†æç”¨æˆ·è¾“å…¥çš„æ„å›¾: {{text_in}}\n\nåˆ†ç±»ä¸ºä»¥ä¸‹ç±»å‹ä¹‹ä¸€:\n1. å’¨è¯¢\n2. æŠ•è¯‰\n3. å»ºè®®\n\nè¯·è¿”å›å¯¹åº”çš„æ•°å­—ç¼–å·ã€‚",
          variables: ["text_in"]  // å¯ç”¨å˜é‡æç¤º
        }
      ]
    },
    {
      title: "é«˜çº§å‚æ•°",
      fields: [
        {
          label: "Temperature",
          type: "slider",
          min: 0,
          max: 1,
          step: 0.1,
          value: 0.7
        },
        {
          label: "Max Tokens",
          type: "number",
          value: 2048
        }
      ]
    }
  ]
}
```

#### ä»£ç å—èŠ‚ç‚¹é…ç½®

```typescript
interface CodeBlockConfigUI {
  tabs: [
    {
      label: "ç®€å•æ¨¡å¼",
      content: {
        type: "expression-builder",
        examples: [
          "æ–‡æœ¬é•¿åº¦ > 100",
          "åŒ…å«å…³é”®è¯('ç´§æ€¥')",
          "æƒ…æ„Ÿåˆ†æ•° < 0.3"
        ]
      }
    },
    {
      label: "ä»£ç æ¨¡å¼", 
      content: {
        type: "code-editor",
        language: "python",
        template: `# è¾“å…¥æ•°æ®: inputs['text_in']
text = inputs['text_in']

# å¤„ç†é€»è¾‘
if 'ç´§æ€¥' in text:
    output = {'signal': 1, 'priority': 'high'}
else:
    output = {'signal': 0, 'priority': 'normal'}

# è¾“å‡ºæ•°æ®ä¼šä¼ é€’ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹`,
        intellisense: true  // ä»£ç æç¤º
      }
    }
  ]
}
```

### ğŸ® äº¤äº’æµç¨‹è®¾è®¡

#### åˆ›å»ºå·¥ä½œæµæµç¨‹

```
1. æ–°å»ºå·¥ä½œæµ
   â†“
2. ä»èŠ‚ç‚¹é¢æ¿æ‹–æ‹½"ç”¨æˆ·è¾“å…¥"èŠ‚ç‚¹åˆ°ç”»å¸ƒ
   â†“ 
3. æ‹–æ‹½"LLMè°ƒç”¨"èŠ‚ç‚¹ï¼Œè‡ªåŠ¨å¸é™„åˆ°"ç”¨æˆ·è¾“å…¥"èŠ‚ç‚¹ä¸‹æ–¹
   â†“
4. ç³»ç»Ÿæç¤ºï¼š"æ˜¯å¦è¿æ¥è¿™ä¸¤ä¸ªèŠ‚ç‚¹ï¼Ÿ" [æ˜¯] [å¦]
   â†“ (é€‰æ‹©[æ˜¯])
5. è‡ªåŠ¨åˆ›å»ºè¿æ¥çº¿ï¼Œæ‰“å¼€LLMèŠ‚ç‚¹é…ç½®é¢æ¿
   â†“
6. é…ç½®æç¤ºè¯ã€æ¨¡å‹ç­‰ï¼Œä¿å­˜
   â†“
7. ç»§ç»­æ·»åŠ æ¡ä»¶åˆ†æ”¯èŠ‚ç‚¹...
```

### ğŸ¯ ç”¨æˆ·ä½“éªŒå¢å¼º

#### æ™ºèƒ½æç¤ºåŠŸèƒ½

```typescript
interface SmartSuggestions {
  // èŠ‚ç‚¹æ¨è
  nodeRecommendation: {
    trigger: "after_llm_node",
    suggestions: ["æ·»åŠ æ¡ä»¶åˆ†æ”¯", "æ·»åŠ ç»“æœèšåˆ", "æ·»åŠ è¾“å‡ºèŠ‚ç‚¹"]
  }
  
  // è¿æ¥æç¤º  
  connectionHint: {
    trigger: "hover_output_port",
    message: "æ‹–æ‹½åˆ°å…¶ä»–èŠ‚ç‚¹çš„è¾“å…¥ç«¯å£æ¥åˆ›å»ºè¿æ¥"
  }
  
  // é”™è¯¯æç¤º
  errorHint: {
    trigger: "invalid_connection", 
    message: "æ­¤è¿æ¥ç±»å‹ä¸åŒ¹é…ï¼ŒLLMè¾“å‡ºåº”è¿æ¥åˆ°æ–‡æœ¬è¾“å…¥ç«¯å£"
  }
}
```

#### å·¥ä½œæµæ‰§è¡Œå¯è§†åŒ–

```typescript
interface ExecutionVisualization {
  // èŠ‚ç‚¹çŠ¶æ€æŒ‡ç¤º
  nodeStatus: {
    waiting: "â³",    // ç­‰å¾…æ‰§è¡Œ
    running: "ğŸ”„",    // æ­£åœ¨æ‰§è¡Œ  
    completed: "âœ…",  // æ‰§è¡Œå®Œæˆ
    error: "âŒ"       // æ‰§è¡Œé”™è¯¯
  }
  
  // æ•°æ®æµåŠ¨ç”»
  dataFlow: {
    enabled: true,
    speed: "2s",      // åŠ¨ç”»é€Ÿåº¦
    showData: true    // æ˜¾ç¤ºä¼ é€’çš„æ•°æ®
  }
  
  // æ‰§è¡Œæ—¥å¿— 
  executionLog: {
    position: "bottom_panel",
    autoScroll: true,
    filters: ["info", "warning", "error"]
  }
}
```

---

## 5. è¯¦ç»†å®ç°è§„èŒƒ

### ğŸ“‹ æ ¸å¿ƒç»„ä»¶å®ç°

#### 1. å¯è§†åŒ–å·¥ä½œæµå¼•æ“ (`orchestrators/visual_workflow.py`)

##### ä¸»è¦ç±»å’Œæ•°æ®ç»“æ„

```python
# èŠ‚ç‚¹ç±»å‹æšä¸¾
class NodeType(Enum):
    INPUT = "input"                    # è¾“å…¥èŠ‚ç‚¹
    LLM_CALL = "llm_call"             # LLMè°ƒç”¨èŠ‚ç‚¹
    CODE_BLOCK = "code_block"         # ä»£ç å—èŠ‚ç‚¹
    CONDITION = "condition"           # æ¡ä»¶åˆ¤æ–­èŠ‚ç‚¹
    SWITCH = "switch"                 # å¼€å…³è·¯ç”±èŠ‚ç‚¹
    MERGER = "merger"                 # ç»“æœèšåˆèŠ‚ç‚¹
    OUTPUT = "output"                 # è¾“å‡ºèŠ‚ç‚¹

# èŠ‚ç‚¹æ•°æ®ç±»
@dataclass
class LLMNodeData:
    node_id: str
    provider: str = "gemini"
    model: str = "gemini-2.5-flash"
    prompt: str = ""
    system_prompt: str = ""
    temperature: float = 0.7
    max_tokens: int = 2048

@dataclass
class CodeBlockNodeData:
    node_id: str
    code_type: str = "python"  # python | javascript
    code: str = ""
    expression: str = ""       # ç®€å•è¡¨è¾¾å¼æ¨¡å¼

# å·¥ä½œæµå®šä¹‰
@dataclass
class WorkflowDefinition:
    id: str
    name: str
    description: str = ""
    nodes: List[WorkflowNode] = None
    edges: List[WorkflowEdge] = None
    metadata: Dict[str, Any] = None

# ä¸»å¼•æ“ç±»
class VisualWorkflow:
    def __init__(self, workflow_def: WorkflowDefinition = None)
    def load_from_definition(self, workflow_def: WorkflowDefinition)
    def _register_nodes(self)          # æ³¨å†Œæ‰€æœ‰èŠ‚ç‚¹ä¸ºå¯æ‰§è¡Œå‡½æ•°
    def _setup_connections(self)       # å»ºç«‹èŠ‚ç‚¹è¿æ¥
    def execute(self, input_data: Dict) -> Dict  # æ‰§è¡Œå·¥ä½œæµ
    def get_execution_state(self) -> Dict        # è·å–æ‰§è¡ŒçŠ¶æ€
```

##### LLMèŠ‚ç‚¹å®ç°

```python
def _register_llm_node(self, node: WorkflowNode):
    def llm_function(**inputs):
        # æ„å»ºæ¶ˆæ¯
        input_text = inputs.get('input', '')
        
        # åº”ç”¨æç¤ºè¯æ¨¡æ¿ï¼ˆæ”¯æŒ{{å˜é‡}}æ›¿æ¢ï¼‰
        prompt = node.data['prompt'].replace('{{input}}', input_text)
        
        # è°ƒç”¨ç°æœ‰LLM API
        response = self.registry.call("api.call", 
                                    messages=[{"role": "user", "content": prompt}],
                                    provider=node.data['provider'],
                                    model=node.data['model'])
        
        # è¿”å›æ ‡å‡†åŒ–ç»“æœ
        return {
            'text': response['response']['content'],
            'signal': self._extract_signal(response),
            'raw_response': response
        }
    
    # æ³¨å†Œåˆ°function_registry
    self.registry.register(f"visual_node_{node.id}", llm_function)
```

##### ä»£ç å—æ‰§è¡Œ

```python
def _execute_python_code(self, code: str, inputs: Dict) -> Dict:
    # æ„å»ºå®‰å…¨æ‰§è¡Œç¯å¢ƒ
    safe_globals = {
        '__builtins__': {'len': len, 'str': str, 'int': int, ...},
        'inputs': inputs,
        'text': inputs.get('text', ''),
        're': __import__('re'),
        'json': __import__('json'),
    }
    
    local_scope = {'output': None}
    exec(code, safe_globals, local_scope)
    
    return local_scope.get('output', {})
```

##### æ¡ä»¶åˆ†æ”¯å¤„ç†

```python
def _register_condition_node(self, node: WorkflowNode):
    def condition_function(**inputs):
        expression = node.data['condition_expression']
        context = {
            'signal': inputs.get('signal'),
            'text': inputs.get('text', ''),
            'length': len(str(inputs.get('text', ''))),
        }
        
        result = eval(expression, {"__builtins__": {}}, context)
        return {
            'condition_result': bool(result),
            'branch': 'true' if result else 'false'
        }
```

#### 2. å¯è§†åŒ–å·¥ä½œæµAPIæ¨¡å— (`modules/visual_workflow_module/`)

##### ç›®å½•ç»“æ„
```
modules/visual_workflow_module/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ visual_workflow_module.py      # APIæ¥å£å‡½æ•°
â”œâ”€â”€ workflow_manager.py            # å·¥ä½œæµç®¡ç†å™¨
â”œâ”€â”€ node_factory.py               # èŠ‚ç‚¹å·¥å‚ç±»
â”œâ”€â”€ execution_monitor.py          # æ‰§è¡Œç›‘æ§
â”œâ”€â”€ README.md
â””â”€â”€ variables.py                   # æ¨¡å—é…ç½®
```

##### APIæ¥å£å®ç°

```python
# modules/visual_workflow_module/visual_workflow_module.py

from core.function_registry import register_function
from core.services import get_current_globals
from orchestrators.visual_workflow import VisualWorkflow, WorkflowDefinition

@register_function(name="visual_workflow.create", outputs=["workflow_id"])
def create_workflow(name: str, description: str = ""):
    """åˆ›å»ºæ–°çš„å¯è§†åŒ–å·¥ä½œæµ"""
    workflow = create_visual_workflow(name)
    
    # å­˜å‚¨åˆ°å…¨å±€çŠ¶æ€
    g = get_current_globals()
    if not hasattr(g, 'visual_workflows'):
        g.visual_workflows = {}
    
    g.visual_workflows[workflow.workflow_def.id] = workflow
    
    return {"workflow_id": workflow.workflow_def.id}

@register_function(name="visual_workflow.add_node", outputs=["node_id", "success"])
def add_node(workflow_id: str, node_type: str, position: dict, config: dict):
    """æ·»åŠ èŠ‚ç‚¹åˆ°å·¥ä½œæµ"""
    g = get_current_globals()
    workflow = g.visual_workflows.get(workflow_id)
    
    if not workflow:
        return {"node_id": None, "success": False, "error": "å·¥ä½œæµä¸å­˜åœ¨"}
    
    # åˆ›å»ºèŠ‚ç‚¹...
    node = create_node(node_type, position, config)
    workflow.workflow_def.nodes.append(node)
    
    # é‡æ–°æ³¨å†ŒèŠ‚ç‚¹
    workflow._register_nodes()
    
    return {"node_id": node.id, "success": True}

@register_function(name="visual_workflow.execute", outputs=["execution_id", "result"])
def execute_workflow(workflow_id: str, inputs: dict = None):
    """æ‰§è¡Œå·¥ä½œæµ"""
    g = get_current_globals()
    workflow = g.visual_workflows.get(workflow_id)
    
    if not workflow:
        return {"execution_id": None, "result": {"success": False, "error": "å·¥ä½œæµä¸å­˜åœ¨"}}
    
    # æ‰§è¡Œå·¥ä½œæµ
    result = workflow.execute(inputs or {})
    
    execution_id = str(uuid.uuid4())
    return {"execution_id": execution_id, "result": result}

@register_function(name="visual_workflow.list", outputs=["workflows"])
def list_workflows():
    """è·å–æ‰€æœ‰å·¥ä½œæµ"""
    g = get_current_globals()
    workflows = getattr(g, 'visual_workflows', {})
    
    workflow_list = []
    for workflow_id, workflow in workflows.items():
        workflow_list.append({
            "id": workflow_id,
            "name": workflow.workflow_def.name,
            "description": workflow.workflow_def.description,
            "node_count": len(workflow.workflow_def.nodes),
            "edge_count": len(workflow.workflow_def.edges)
        })
    
    return {"workflows": workflow_list}
```

### ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

#### 1. ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ

- **å¤ç”¨SimpleWorkflow**: ä½œä¸ºåº•å±‚æ‰§è¡Œå¼•æ“
- **å¤ç”¨function_registry**: æ³¨å†Œå¯è§†åŒ–èŠ‚ç‚¹ä¸ºæ ‡å‡†å‡½æ•°
- **å¤ç”¨LLM APIç³»ç»Ÿ**: è°ƒç”¨ç°æœ‰çš„api.callæ¥å£
- **å¤ç”¨APIç½‘å…³**: é€šè¿‡function_registryè‡ªåŠ¨æš´éœ²REST API

#### 2. æ•°æ®æ ¼å¼ç®€åŒ–

```python
# ç®€åŒ–çš„æ•°æ®ä¼ é€’æ ¼å¼
NodeOutput = {
    'text': str,          # ä¸»è¦æ–‡æœ¬å†…å®¹
    'signal': int/None,   # æ§åˆ¶ä¿¡å·ï¼ˆç”¨äºæ¡ä»¶åˆ†æ”¯ï¼‰
    'metadata': dict      # å¯é€‰å…ƒæ•°æ®
}
```

#### 3. å®‰å…¨æ‰§è¡Œç¯å¢ƒ

```python
# ä»£ç å—å®‰å…¨æ‰§è¡Œç¯å¢ƒ
safe_globals = {
    '__builtins__': {
        'len': len, 'str': str, 'int': int, 'float': float,
        'dict': dict, 'list': list, 'min': min, 'max': max,
        'sum': sum, 'any': any, 'all': all
    },
    'inputs': inputs,
    're': __import__('re'),      # æ­£åˆ™è¡¨è¾¾å¼
    'json': __import__('json'),   # JSONå¤„ç†
    'time': __import__('time'),   # æ—¶é—´å‡½æ•°
}
```

#### 4. é”™è¯¯å¤„ç†æœºåˆ¶

```python
# èŠ‚ç‚¹æ‰§è¡Œé”™è¯¯å¤„ç†
try:
    result = node_function(**inputs)
    return result
except Exception as e:
    return {
        'text': f"èŠ‚ç‚¹æ‰§è¡Œé”™è¯¯: {str(e)}",
        'signal': None,
        'error': str(e),
        'node_id': node.id
    }
```

---

## 6. å…¼å®¹æ€§åˆ†æ

### ğŸ“Š å…¼å®¹æ€§è¯„ä¼°ç»“æœ

âœ… **å®Œå…¨å…¼å®¹** - å¯è§†åŒ–å·¥ä½œæµç³»ç»Ÿè®¾è®¡ä¸ç°æœ‰ModularFlow Frameworkæ¶æ„å®Œç¾å¥‘åˆï¼

### ğŸ—ï¸ æ¶æ„é›†æˆåˆ†æ

#### 1. å‰ç«¯é¡¹ç›®é›†æˆ

åŸºäº[`web_server_module`](modules/web_server_module/README.md)çš„ç°æœ‰èƒ½åŠ›ï¼š

```json
// frontend_projects/frontend-projects.json æ–°å¢é…ç½®
{
  "projects": [
    {
      "name": "visual_workflow_editor",
      "display_name": "å¯è§†åŒ–å·¥ä½œæµç¼–è¾‘å™¨", 
      "type": "react",
      "path": "frontend_projects/visual_workflow_editor",
      "port": 3002,
      "api_endpoint": "http://localhost:6500/api/v1",
      "build_command": "npm run build",
      "dev_command": "npm start",
      "description": "å¤šLLMååŒçš„å¯è§†åŒ–å·¥ä½œæµç¼–æ’å¹³å°",
      "dependencies": {
        "react": "^18.0.0",
        "react-flow-renderer": "^10.0.0",
        "antd": "^5.0.0",
        "axios": "^1.0.0"
      },
      "enabled": true
    }
  ]
}
```

#### 2. åç«¯æ¨¡å—é›†æˆ

**æ¨¡å—ä½ç½®**: `modules/visual_workflow_module/`

```python
# modules/visual_workflow_module/__init__.py
from .visual_workflow_module import get_visual_workflow_manager

# modules/visual_workflow_module/visual_workflow_module.py
from core.function_registry import register_function
from core.services import get_current_globals

@register_function(name="visual_workflow.create", outputs=["workflow_id"])
def create_workflow(name: str, description: str = ""):
    """åˆ›å»ºæ–°çš„å¯è§†åŒ–å·¥ä½œæµ"""
    pass

@register_function(name="visual_workflow.execute", outputs=["execution_id"])  
def execute_workflow(workflow_id: str, inputs: dict = None):
    """æ‰§è¡Œå¯è§†åŒ–å·¥ä½œæµ"""
    pass
```

### 3. ä¸ç°æœ‰ç³»ç»Ÿçš„å®Œç¾å¥‘åˆ

#### âœ… WebæœåŠ¡å™¨æ¨¡å—å…¼å®¹æ€§
- **é¡¹ç›®ç®¡ç†**: å¯ç›´æ¥ä½¿ç”¨`web_server.start_project("visual_workflow_editor")`å¯åŠ¨
- **å¼€å‘ç¯å¢ƒ**: æ”¯æŒReactçƒ­é‡è½½ã€è‡ªåŠ¨æµè§ˆå™¨æ‰“å¼€
- **å¤šç«¯å£ç®¡ç†**: é¿å…ä¸ç°æœ‰SmartTavern(6601)ç­‰é¡¹ç›®å†²çª

#### âœ… APIç½‘å…³é›†æˆ
- **RESTful API**: é€šè¿‡ç°æœ‰APIç½‘å…³(`localhost:6500/api/v1`)æš´éœ²æ¥å£
- **WebSocketæ”¯æŒ**: å¤ç”¨ç°æœ‰WebSocketç³»ç»Ÿå®ç°å®æ—¶ç›‘æ§
- **CORSå¤„ç†**: è‡ªåŠ¨å¤„ç†è·¨åŸŸè¯·æ±‚

#### âœ… å‡½æ•°æ³¨å†Œç³»ç»Ÿ
- **æ— ç¼é›†æˆ**: æ‰€æœ‰å¯è§†åŒ–å·¥ä½œæµAPIéƒ½é€šè¿‡function_registryæ³¨å†Œ
- **è‡ªåŠ¨å‘ç°**: APIç½‘å…³è‡ªåŠ¨æš´éœ²æ³¨å†Œçš„å‡½æ•°ä¸ºRESTç«¯ç‚¹
- **ç»Ÿä¸€è°ƒç”¨**: å‰ç«¯å¯é€šè¿‡æ ‡å‡†APIæ ¼å¼è°ƒç”¨åç«¯åŠŸèƒ½

### ğŸš€ å®é™…é›†æˆç¤ºä¾‹

#### å¯åŠ¨å®Œæ•´å¼€å‘ç¯å¢ƒ

```python
# ä¸€é”®å¯åŠ¨åŒ…å«å¯è§†åŒ–ç¼–è¾‘å™¨çš„å®Œæ•´å¼€å‘ç¯å¢ƒ
from modules.web_server_module import get_web_server
from modules.api_gateway_module import get_api_gateway

# 1. å¯åŠ¨APIç½‘å…³ï¼ˆåç«¯ï¼‰
gateway = get_api_gateway()
gateway.start_server(background=True)

# 2. å¯åŠ¨SmartTavernï¼ˆç°æœ‰ç³»ç»Ÿï¼‰
server = get_web_server() 
server.start_project("SmartTavern")  # http://localhost:6601

# 3. å¯åŠ¨å¯è§†åŒ–å·¥ä½œæµç¼–è¾‘å™¨ï¼ˆæ–°çš„ï¼‰
server.start_project("visual_workflow_editor")  # http://localhost:3002

print("ğŸš€ å®Œæ•´å¼€å‘ç¯å¢ƒå·²å¯åŠ¨:")
print("ğŸ“Š APIæ–‡æ¡£: http://localhost:6500/docs")
print("ğŸ’¬ SmartTavern: http://localhost:6601") 
print("ğŸ¨ å¯è§†åŒ–ç¼–è¾‘å™¨: http://localhost:3002")
```

#### å‰ç«¯APIè°ƒç”¨ç¤ºä¾‹

```typescript
// frontend_projects/visual_workflow_editor/src/services/api.ts
import axios from 'axios';

const API_BASE = 'http://localhost:6500/api/v1';

export class VisualWorkflowAPI {
  // åˆ›å»ºå·¥ä½œæµ
  async createWorkflow(name: string, description?: string) {
    const response = await axios.post(`${API_BASE}/visual_workflow/create`, {
      name, description
    });
    return response.data;
  }
  
  // æ‰§è¡Œå·¥ä½œæµ 
  async executeWorkflow(workflowId: string, inputs?: any) {
    const response = await axios.post(`${API_BASE}/visual_workflow/execute`, {
      workflow_id: workflowId, inputs
    });
    return response.data;
  }
  
  // WebSocketå®æ—¶ç›‘æ§
  connectToExecution(executionId: string) {
    const ws = new WebSocket(`ws://localhost:6500/ws`);
    ws.send(JSON.stringify({
      type: 'subscribe',
      channel: `execution_${executionId}`
    }));
    return ws;
  }
}
```

### ğŸ“Š å…¼å®¹æ€§è¯„åˆ†

| ç»„ä»¶ | å…¼å®¹æ€§ | å¤ç”¨åº¦ | å¼€å‘å·¥ä½œé‡ |
|------|--------|--------|------------|
| WebæœåŠ¡å™¨æ¨¡å— | ğŸ’¯ 100% | ğŸ”„ å®Œå…¨å¤ç”¨ | â­ é›¶å·¥ä½œé‡ |
| APIç½‘å…³ç³»ç»Ÿ | ğŸ’¯ 100% | ğŸ”„ å®Œå…¨å¤ç”¨ | â­ é›¶å·¥ä½œé‡ |
| å‡½æ•°æ³¨å†Œç³»ç»Ÿ | ğŸ’¯ 100% | ğŸ”„ å®Œå…¨å¤ç”¨ | â­ é›¶å·¥ä½œé‡ |
| LLM APIç³»ç»Ÿ | ğŸ’¯ 100% | ğŸ”„ å®Œå…¨å¤ç”¨ | â­ é›¶å·¥ä½œé‡ |
| SimpleWorkflow | ğŸ¯ 95% | ğŸ“ˆ æ‰©å±•å¤ç”¨ | â­â­ å°‘é‡æ‰©å±• |
| å‰ç«¯æŠ€æœ¯æ ˆ | ğŸ’¯ 100% | âœ¨ æ–°å»ºå¤ç”¨ | â­â­â­ æ–°å»ºå¼€å‘ |

### âœ… ç»“è®º

**å¯è§†åŒ–å·¥ä½œæµç³»ç»Ÿè®¾è®¡ä¸ModularFlow Frameworkç°æœ‰æ¶æ„å…·æœ‰å®Œç¾çš„å…¼å®¹æ€§ï¼**

- ğŸ¯ **é›¶æ¶æ„å†²çª**: æ‰€æœ‰è®¾è®¡éƒ½åŸºäºç°æœ‰çš„æ¨¡å—åŒ–è§„èŒƒ
- ğŸ”„ **æœ€å¤§åŒ–å¤ç”¨**: å¯ä»¥ç›´æ¥åˆ©ç”¨80%çš„ç°æœ‰åŸºç¡€è®¾æ–½
- ğŸ“ˆ **æ¸è¿›å¼å¼€å‘**: å¯ä»¥é€æ­¥å¼€å‘ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- ğŸš€ **å¿«é€Ÿäº¤ä»˜**: é¢„è®¡2-4å‘¨å†…å¯å®Œæˆå¯ç”¨ç‰ˆæœ¬

---

## 7. å¼€å‘è·¯çº¿å›¾

### ğŸ“… Phase 1: æ ¸å¿ƒå¼•æ“å¼€å‘ (1-2å‘¨)

#### ğŸ¯ ç›®æ ‡ï¼šå»ºç«‹åŸºç¡€å·¥ä½œæµæ‰§è¡Œèƒ½åŠ›

**ä¸»è¦ä»»åŠ¡ï¼š**
- âœ… å®ç°`VisualWorkflow`æ ¸å¿ƒç±»
- âœ… å®ç°LLMèŠ‚ç‚¹æ³¨å†Œå’Œæ‰§è¡Œæœºåˆ¶
- âœ… å®ç°åŸºç¡€ä»£ç å—èŠ‚ç‚¹ï¼ˆPythonæ¨¡å¼ï¼‰
- âœ… å®ç°èŠ‚ç‚¹è¿æ¥å’Œæ•°æ®ä¼ é€’æœºåˆ¶
- âœ… åˆ›å»º`visual_workflow_module`æ¨¡å—
- âœ… å®ç°åŸºç¡€APIæ¥å£ï¼ˆåˆ›å»ºã€æ‰§è¡Œå·¥ä½œæµï¼‰

**äº¤ä»˜ç‰©ï¼š**
- `orchestrators/visual_workflow.py`
- `modules/visual_workflow_module/`å®Œæ•´æ¨¡å—
- åŸºç¡€APIæ¥å£å¯ç”¨
- ç®€å•å·¥ä½œæµå¯æ‰§è¡Œ

**éªŒæ”¶æ ‡å‡†ï¼š**
- èƒ½é€šè¿‡APIåˆ›å»ºç®€å•çš„LLMå·¥ä½œæµ
- èƒ½æ‰§è¡Œå•é“¾è·¯çš„LLMè°ƒç”¨
- æ”¯æŒåŸºç¡€çš„æ•°æ®ä¼ é€’
- ä¸ç°æœ‰ç³»ç»Ÿæ— å†²çª

### ğŸ“… Phase 2: å‰ç«¯ç¼–è¾‘å™¨å¼€å‘ (2-3å‘¨)

#### ğŸ¯ ç›®æ ‡ï¼šæä¾›åŸºç¡€çš„å¯è§†åŒ–ç¼–è¾‘èƒ½åŠ›

**ä¸»è¦ä»»åŠ¡ï¼š**
- ğŸ¨ æ­å»ºReactå‰ç«¯é¡¹ç›®æ¶æ„
- ğŸ–±ï¸ å®ç°åŸºç¡€çš„æ‹–æ‹½ç”»å¸ƒï¼ˆä½¿ç”¨React Flowï¼‰
- ğŸ§© å®ç°åŸºç¡€èŠ‚ç‚¹ç±»å‹ï¼ˆLLMã€ä»£ç å—ã€è¾“å…¥è¾“å‡ºï¼‰
- ğŸ”— å®ç°èŠ‚ç‚¹è¿æ¥åŠŸèƒ½
- âš™ï¸ å®ç°èŠ‚ç‚¹å±æ€§é…ç½®é¢æ¿
- ğŸ”„ å®ç°ä¸åç«¯APIçš„é›†æˆ
- ğŸ’¾ å®ç°å·¥ä½œæµä¿å­˜å’ŒåŠ è½½

**äº¤ä»˜ç‰©ï¼š**
- `frontend_projects/visual_workflow_editor/`å®Œæ•´å‰ç«¯é¡¹ç›®
- åŸºç¡€å¯è§†åŒ–ç¼–è¾‘ç•Œé¢
- èŠ‚ç‚¹é…ç½®åŠŸèƒ½
- å·¥ä½œæµæ‰§è¡Œç•Œé¢

**éªŒæ”¶æ ‡å‡†ï¼š**
- å¯é€šè¿‡æ‹–æ‹½åˆ›å»ºç®€å•å·¥ä½œæµ
- å¯é…ç½®LLMèŠ‚ç‚¹å‚æ•°
- å¯ä¿å­˜å’ŒåŠ è½½å·¥ä½œæµ
- å¯æ‰§è¡Œå·¥ä½œæµå¹¶æŸ¥çœ‹ç»“æœ

### ğŸ“… Phase 3: é«˜çº§åŠŸèƒ½å¼€å‘ (2-3å‘¨)

#### ğŸ¯ ç›®æ ‡ï¼šæ”¯æŒå¤æ‚å·¥ä½œæµåœºæ™¯

**ä¸»è¦ä»»åŠ¡ï¼š**
- âš¡ å®ç°æ¡ä»¶åˆ†æ”¯èŠ‚ç‚¹
- ğŸ¯ å®ç°ç»“æœèšåˆèŠ‚ç‚¹
- ğŸ”„ å®ç°å·¥ä½œæµæ‰§è¡ŒçŠ¶æ€å®æ—¶ç›‘æ§
- ğŸ“Š å®ç°æ‰§è¡Œè¿‡ç¨‹å¯è§†åŒ–
- ğŸ§ª å®ç°å·¥ä½œæµè°ƒè¯•åŠŸèƒ½
- ğŸ“ å®ç°å·¥ä½œæµæ¨¡æ¿ç³»ç»Ÿ
- ğŸ” å®ç°æ‰§è¡Œæ—¥å¿—å’Œé”™è¯¯å¤„ç†

**äº¤ä»˜ç‰©ï¼š**
- å®Œæ•´çš„èŠ‚ç‚¹ç±»å‹æ”¯æŒ
- å®æ—¶æ‰§è¡Œç›‘æ§ç•Œé¢
- å·¥ä½œæµæ¨¡æ¿åº“
- è°ƒè¯•å’Œæ—¥å¿—ç³»ç»Ÿ

**éªŒæ”¶æ ‡å‡†ï¼š**
- æ”¯æŒæ¡ä»¶åˆ†æ”¯çš„å¤æ‚å·¥ä½œæµ
- å¯å®æ—¶ç›‘æ§æ‰§è¡ŒçŠ¶æ€
- æä¾›ä¸°å¯Œçš„è°ƒè¯•ä¿¡æ¯
- åŒ…å«å¸¸ç”¨å·¥ä½œæµæ¨¡æ¿

### ğŸ“… Phase 4: ä¼˜åŒ–å’Œæ‰©å±• (1-2å‘¨)

#### ğŸ¯ ç›®æ ‡ï¼šæå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿç¨³å®šæ€§

**ä¸»è¦ä»»åŠ¡ï¼š**
- ğŸ¨ ç•Œé¢ç¾åŒ–å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–
- âš¡ æ€§èƒ½ä¼˜åŒ–ï¼ˆæ‰§è¡Œé€Ÿåº¦ã€ç•Œé¢å“åº”ï¼‰
- ğŸ“š æ–‡æ¡£å®Œå–„å’Œç¤ºä¾‹è¡¥å……
- ğŸ§ª å…¨é¢æµ‹è¯•å’Œbugä¿®å¤
- ğŸ”§ ç³»ç»Ÿç›‘æ§å’Œæ—¥å¿—å®Œå–„
- ğŸ“¦ éƒ¨ç½²å’Œå‘å¸ƒå‡†å¤‡

**äº¤ä»˜ç‰©ï¼š**
- å®Œæ•´çš„ç”¨æˆ·æ–‡æ¡£
- æ€§èƒ½ä¼˜åŒ–ç‰ˆæœ¬
- å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- éƒ¨ç½²æŒ‡å—

**éªŒæ”¶æ ‡å‡†ï¼š**
- ç³»ç»Ÿç¨³å®šè¿è¡Œæ— é‡å¤§bug
- ç”¨æˆ·ä½“éªŒæµç•…å‹å¥½
- æ–‡æ¡£å®Œæ•´æ¸…æ™°
- å¯ç”¨äºç”Ÿäº§ç¯å¢ƒ

### ğŸ—“ï¸ æ€»ä½“æ—¶é—´è¡¨

```mermaid
gantt
    title å¯è§†åŒ–å·¥ä½œæµå¼€å‘ç”˜ç‰¹å›¾
    dateFormat  YYYY-MM-DD
    section Phase 1: æ ¸å¿ƒå¼•æ“
    æ ¸å¿ƒå¼•æ“å¼€å‘       :active, p1, 2025-01-17, 14d
    APIæ¥å£å®ç°        :p1-api, after p1, 7d
    
    section Phase 2: å‰ç«¯ç¼–è¾‘å™¨  
    å‰ç«¯æ¶æ„æ­å»º       :p2, after p1-api, 7d
    åŸºç¡€ç¼–è¾‘åŠŸèƒ½       :p2-edit, after p2, 14d
    
    section Phase 3: é«˜çº§åŠŸèƒ½
    æ¡ä»¶åˆ†æ”¯åŠŸèƒ½       :p3, after p2-edit, 10d
    ç›‘æ§è°ƒè¯•åŠŸèƒ½       :p3-monitor, after p3, 11d
    
    section Phase 4: ä¼˜åŒ–æ‰©å±•
    æ€§èƒ½ä¼˜åŒ–          :p4, after p3-monitor, 7d
    æ–‡æ¡£æµ‹è¯•          :p4-doc, after p4, 7d
```

### ğŸš¦ é‡Œç¨‹ç¢‘èŠ‚ç‚¹

| æ—¶é—´ç‚¹ | é‡Œç¨‹ç¢‘ | ä¸»è¦æˆæœ |
|--------|--------|----------|
| ç¬¬2å‘¨æœ« | MVPæ ¸å¿ƒ | åç«¯å¼•æ“å¯æ‰§è¡Œç®€å•å·¥ä½œæµ |
| ç¬¬4å‘¨æœ« | Alphaç‰ˆæœ¬ | å‰ç«¯ç¼–è¾‘å™¨åŸºç¡€åŠŸèƒ½å¯ç”¨ |
| ç¬¬7å‘¨æœ« | Betaç‰ˆæœ¬ | å®Œæ•´åŠŸèƒ½å¯ç”¨ï¼Œæ”¯æŒå¤æ‚åœºæ™¯ |
| ç¬¬8å‘¨æœ« | Releaseç‰ˆæœ¬ | ç”Ÿäº§å°±ç»ªï¼Œæ–‡æ¡£å®Œæ•´ |

### ğŸ“‹ å…³é”®é£é™©å’Œç¼“è§£æªæ–½

| é£é™©é¡¹ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|--------|------|------|----------|
| React Flowå­¦ä¹ æ›²çº¿ | ä¸­ | ä¸­ | æå‰æŠ€æœ¯é¢„ç ”ï¼Œå‡†å¤‡å¤‡é€‰æ–¹æ¡ˆ |
| å¤æ‚å·¥ä½œæµæ‰§è¡Œæ€§èƒ½ | é«˜ | ä½ | åˆ†é˜¶æ®µå‹åŠ›æµ‹è¯•ï¼Œæ€§èƒ½ç›‘æ§ |
| APIæ¥å£è®¾è®¡å˜æ›´ | ä¸­ | ä½ | APIç‰ˆæœ¬åŒ–ï¼Œå‘åå…¼å®¹ |
| å‰åç«¯é›†æˆé—®é¢˜ | ä¸­ | ä¸­ | æŒç»­é›†æˆæµ‹è¯•ï¼Œæ¨¡æ‹Ÿæ•°æ®æµ‹è¯• |

---

## 8. æŠ€æœ¯æ ˆå’Œä¾èµ–æ¸…å•

### ğŸ–¥ï¸ åç«¯æŠ€æœ¯æ ˆ

#### æ ¸å¿ƒä¾èµ–

```python
# requirements.txt æ–°å¢ä¾èµ–
fastapi>=0.104.0              # Web APIæ¡†æ¶ï¼ˆå·²æœ‰ï¼‰
websockets>=11.0              # WebSocketæ”¯æŒï¼ˆå·²æœ‰ï¼‰
pydantic>=2.0.0              # æ•°æ®éªŒè¯ï¼ˆå·²æœ‰ï¼‰
uvicorn>=0.24.0              # ASGIæœåŠ¡å™¨ï¼ˆå·²æœ‰ï¼‰

# æ–°å¢å¯è§†åŒ–å·¥ä½œæµç‰¹å®šä¾èµ–
graphlib>=0.1.0              # å›¾ç®—æ³•ï¼ˆç”¨äºå·¥ä½œæµæ‹“æ‰‘æ’åºï¼‰
networkx>=3.2                # å›¾å¤„ç†åº“ï¼ˆå¯é€‰ï¼Œç”¨äºå¤æ‚å›¾åˆ†æï¼‰
croniter>=1.4.0              # å®šæ—¶ä»»åŠ¡æ”¯æŒï¼ˆæœªæ¥æ‰©å±•ï¼‰
```

#### Pythonæ¨¡å—ç»“æ„

```python
# modules/visual_workflow_module/ ä¾èµ–ç»“æ„
dependencies = {
    "core_modules": [
        "orchestrators.simple_workflow",    # åŸºç¡€å·¥ä½œæµå¼•æ“
        "core.function_registry",          # å‡½æ•°æ³¨å†Œç³»ç»Ÿ
        "core.services",                   # å…¨å±€æœåŠ¡
    ],
    "llm_integration": [
        "modules.llm_api_module",          # LLM APIæ¨¡å—
        "modules.api_gateway_module",      # APIç½‘å…³æ¨¡å—
    ],
    "web_services": [
        "modules.web_server_module",       # WebæœåŠ¡å™¨
    ],
    "external": [
        "uuid", "json", "typing", "dataclasses",
        "asyncio", "logging", "time"
    ]
}
```

### ğŸ¨ å‰ç«¯æŠ€æœ¯æ ˆ

#### æ ¸å¿ƒæ¡†æ¶

```json
{
  "name": "visual-workflow-editor",
  "version": "1.0.0",
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "typescript": "^5.2.0",
    
    "react-flow-renderer": "^11.0.0",
    "reactflow": "^11.10.0",
    
    "antd": "^5.12.0",
    "@ant-design/icons": "^5.2.0",
    
    "axios": "^1.6.0",
    "socket.io-client": "^4.7.0",
    
    "monaco-editor": "^0.45.0",
    "@monaco-editor/react": "^4.6.0",
    
    "zustand": "^4.4.0",
    "immer": "^10.0.0",
    
    "mermaid": "^10.6.0",
    "dagre": "^0.8.5"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.1.0",
    "vite": "^5.0.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "eslint": "^8.53.0",
    "@typescript-eslint/eslint-plugin": "^6.10.0"
  }
}
```

#### å…³é”®åº“è¯´æ˜

| åº“å | ç”¨é€” | ç‰ˆæœ¬ | è¯´æ˜ |
|------|------|------|------|
| **React Flow** | å¯è§†åŒ–æµç¨‹å›¾ | ^11.0.0 | æ‹–æ‹½ç”»å¸ƒã€èŠ‚ç‚¹è¿æ¥ |
| **Ant Design** | UIç»„ä»¶åº“ | ^5.12.0 | é…ç½®è¡¨å•ã€æŒ‰é’®ã€é¢æ¿ |
| **Monaco Editor** | ä»£ç ç¼–è¾‘å™¨ | ^0.45.0 | ä»£ç å—èŠ‚ç‚¹ç¼–è¾‘ |
| **Zustand** | çŠ¶æ€ç®¡ç† | ^4.4.0 | è½»é‡çº§çŠ¶æ€ç®¡ç† |
| **Axios** | HTTPå®¢æˆ·ç«¯ | ^1.6.0 | APIè°ƒç”¨ |
| **Socket.io** | WebSocket | ^4.7.0 | å®æ—¶çŠ¶æ€åŒæ­¥ |

### ğŸ”§ å¼€å‘å·¥å…·é“¾

#### æ„å»ºå·¥å…·

```json
// vite.config.ts
{
  "build_tool": "Vite 5.0+",
  "bundler": "Rollup",
  "dev_server": "Vite Dev Server",
  "hot_reload": "Fast Refresh",
  "typescript": "5.2+",
  "css_processing": "PostCSS + Autoprefixer"
}
```

#### ä»£ç è´¨é‡å·¥å…·

```json
// .eslintrc.json
{
  "linting": "ESLint 8.53+",
  "formatting": "Prettier 3.0+",
  "type_checking": "TypeScript strict mode",
  "git_hooks": "Husky + lint-staged"
}
```

### ğŸ“¦ éƒ¨ç½²å’Œè¿ç»´

#### å®¹å™¨åŒ–é…ç½®

```dockerfile
# Dockerfile (å‰ç«¯)
FROM node:18-alpine as builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
RUN npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 80
```

#### ç¯å¢ƒé…ç½®

```yaml
# docker-compose.yml
version: '3.8'
services:
  visual-workflow-editor:
    build: ./frontend_projects/visual_workflow_editor
    ports:
      - "3002:80"
    environment:
      - REACT_APP_API_BASE=http://localhost:6500/api/v1
      - REACT_APP_WS_URL=ws://localhost:6500/ws
    depends_on:
      - api-gateway
      
  api-gateway:
    build: ./
    ports:
      - "6500:6500"
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=info
```

### ğŸ” å®‰å…¨é…ç½®

#### APIå®‰å…¨

```python
# å®‰å…¨ä¸­é—´ä»¶é…ç½®
security_config = {
    "cors": {
        "allow_origins": ["http://localhost:3002"],
        "allow_methods": ["GET", "POST", "PUT", "DELETE"],
        "allow_headers": ["*"],
    },
    "rate_limiting": {
        "requests_per_minute": 100,
        "burst_size": 20,
    },
    "authentication": {
        "enabled": True,  # ç”Ÿäº§ç¯å¢ƒå¯ç”¨
        "jwt_secret": "your-secret-key",
    }
}
```

#### ä»£ç æ‰§è¡Œå®‰å…¨

```python
# ä»£ç å—å®‰å…¨æ‰§è¡Œç¯å¢ƒ
SAFE_BUILTINS = {
    'len', 'str', 'int', 'float', 'dict', 'list',
    'min', 'max', 'sum', 'any', 'all', 'range',
    'enumerate', 'zip', 'sorted', 'reversed'
}

ALLOWED_MODULES = {
    're': ['search', 'match', 'findall', 'sub'],
    'json': ['loads', 'dumps'],
    'time': ['time', 'strftime', 'strptime'],
    'math': ['ceil', 'floor', 'round', 'sqrt']
}
```

### ğŸ“Š æ€§èƒ½è¦æ±‚

#### å‰ç«¯æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|----------|
| é¦–æ¬¡å†…å®¹ç»˜åˆ¶ (FCP) | < 1.5s | Lighthouse |
| æœ€å¤§å†…å®¹ç»˜åˆ¶ (LCP) | < 2.5s | Lighthouse |
| äº¤äº’å‡†å¤‡æ—¶é—´ (TTI) | < 3.0s | Lighthouse |
| ç”»å¸ƒèŠ‚ç‚¹æ¸²æŸ“ | < 100ms | è‡ªå®šä¹‰è®¡æ—¶å™¨ |
| æ‹–æ‹½å“åº”å»¶è¿Ÿ | < 16ms | æµè§ˆå™¨å¼€å‘å·¥å…· |

#### åç«¯æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|----------|
| APIå“åº”æ—¶é—´ | < 200ms | APMå·¥å…· |
| å·¥ä½œæµæ‰§è¡Œå¯åŠ¨ | < 500ms | å†…éƒ¨è®¡æ—¶å™¨ |
| å¹¶å‘å·¥ä½œæµæ•° | > 100 | å‹åŠ›æµ‹è¯• |
| å†…å­˜ä½¿ç”¨ | < 512MB | ç³»ç»Ÿç›‘æ§ |
| CPUä½¿ç”¨ç‡ | < 80% | ç³»ç»Ÿç›‘æ§ |

---

## 9. å¼€å‘æ£€æŸ¥æ¸…å•

### âœ… åç«¯å¼€å‘æ£€æŸ¥æ¸…å•

#### æ ¸å¿ƒå¼•æ“å¼€å‘

- [ ] **VisualWorkflowç±»å®ç°**
  - [ ] å·¥ä½œæµå®šä¹‰åŠ è½½
  - [ ] èŠ‚ç‚¹æ³¨å†Œæœºåˆ¶
  - [ ] è¿æ¥å»ºç«‹æœºåˆ¶
  - [ ] æ‰§è¡Œè°ƒåº¦é€»è¾‘
  - [ ] çŠ¶æ€ç®¡ç†

- [ ] **èŠ‚ç‚¹ç±»å‹å®ç°**
  - [ ] INPUTèŠ‚ç‚¹ (ç”¨æˆ·è¾“å…¥)
  - [ ] LLM_CALLèŠ‚ç‚¹ (LLMè°ƒç”¨)
  - [ ] CODE_BLOCKèŠ‚ç‚¹ (ä»£ç æ‰§è¡Œ)
  - [ ] CONDITIONèŠ‚ç‚¹ (æ¡ä»¶åˆ¤æ–­)
  - [ ] SWITCHèŠ‚ç‚¹ (è·¯å¾„é€‰æ‹©)
  - [ ] MERGERèŠ‚ç‚¹ (ç»“æœèšåˆ)
  - [ ] OUTPUTèŠ‚ç‚¹ (è¾“å‡ºæ˜¾ç¤º)

- [ ] **æ•°æ®æµå¤„ç†**
  - [ ] ç®€åŒ–æ•°æ®ç±»å‹æ”¯æŒ
  - [ ] æ¡ä»¶åˆ†æ”¯é€»è¾‘
  - [ ] é”™è¯¯å¤„ç†å’Œæ¢å¤
  - [ ] æ•°æ®è½¬æ¢å’ŒéªŒè¯

#### APIæ¨¡å—å¼€å‘

- [ ] **visual_workflow_moduleå®ç°**
  - [ ] æ¨¡å—ç»“æ„åˆ›å»º
  - [ ] function_registryé›†æˆ
  - [ ] APIå‡½æ•°å®ç°
  - [ ] é”™è¯¯å¤„ç†

- [ ] **æ ¸å¿ƒAPIæ¥å£**
  - [ ] visual_workflow.create
  - [ ] visual_workflow.add_node
  - [ ] visual_workflow.connect_nodes
  - [ ] visual_workflow.execute
  - [ ] visual_workflow.get_status
  - [ ] visual_workflow.list

- [ ] **å·¥ä½œæµç®¡ç†**
  - [ ] å·¥ä½œæµCRUDæ“ä½œ
  - [ ] æ¨¡æ¿ç³»ç»Ÿ
  - [ ] å¯¼å…¥å¯¼å‡ºåŠŸèƒ½
  - [ ] ç‰ˆæœ¬ç®¡ç†

#### ä»£ç å®‰å…¨

- [ ] **å®‰å…¨æ‰§è¡Œç¯å¢ƒ**
  - [ ] é™åˆ¶å¯ç”¨å†…ç½®å‡½æ•°
  - [ ] æ¨¡å—å¯¼å…¥ç™½åå•
  - [ ] æ‰§è¡Œæ—¶é—´é™åˆ¶
  - [ ] å†…å­˜ä½¿ç”¨é™åˆ¶

- [ ] **è¾“å…¥éªŒè¯**
  - [ ] APIå‚æ•°éªŒè¯
  - [ ] èŠ‚ç‚¹é…ç½®éªŒè¯
  - [ ] ä»£ç å—å†…å®¹æ£€æŸ¥
  - [ ] SQLæ³¨å…¥é˜²æŠ¤

### âœ… å‰ç«¯å¼€å‘æ£€æŸ¥æ¸…å•

#### æ ¸å¿ƒç•Œé¢å¼€å‘

- [ ] **é¡¹ç›®æ¶æ„æ­å»º**
  - [ ] React + TypeScripté…ç½®
  - [ ] Viteæ„å»ºé…ç½®
  - [ ] ESLint + Prettieré…ç½®
  - [ ] ç›®å½•ç»“æ„å»ºç«‹

- [ ] **ç”»å¸ƒç»„ä»¶å¼€å‘**
  - [ ] React Flowé›†æˆ
  - [ ] è‡ªå®šä¹‰èŠ‚ç‚¹ç»„ä»¶
  - [ ] è¿æ¥çº¿æ ·å¼
  - [ ] æ‹–æ‹½äº¤äº’

- [ ] **èŠ‚ç‚¹ç»„ä»¶å¼€å‘**
  - [ ] LLMèŠ‚ç‚¹ç»„ä»¶
  - [ ] ä»£ç å—èŠ‚ç‚¹ç»„ä»¶
  - [ ] æ¡ä»¶èŠ‚ç‚¹ç»„ä»¶
  - [ ] è¾“å…¥è¾“å‡ºèŠ‚ç‚¹ç»„ä»¶

#### é…ç½®ç•Œé¢å¼€å‘

- [ ] **å±æ€§é¢æ¿**
  - [ ] åŠ¨æ€è¡¨å•ç”Ÿæˆ
  - [ ] èŠ‚ç‚¹é…ç½®è¡¨å•
  - [ ] å®æ—¶é¢„è§ˆåŠŸèƒ½
  - [ ] éªŒè¯å’Œé”™è¯¯æç¤º

- [ ] **ä»£ç ç¼–è¾‘å™¨**
  - [ ] Monaco Editoré›†æˆ
  - [ ] è¯­æ³•é«˜äº®
  - [ ] è‡ªåŠ¨è¡¥å…¨
  - [ ] é”™è¯¯æ£€æŸ¥

- [ ] **ç•Œé¢å¸ƒå±€**
  - [ ] å“åº”å¼å¸ƒå±€
  - [ ] å¯è°ƒæ•´é¢æ¿å°ºå¯¸
  - [ ] ä¸»é¢˜åˆ‡æ¢æ”¯æŒ
  - [ ] å¿«æ·é”®æ”¯æŒ

#### åŠŸèƒ½ç‰¹æ€§

- [ ] **å·¥ä½œæµç®¡ç†**
  - [ ] åˆ›å»ºæ–°å·¥ä½œæµ
  - [ ] ä¿å­˜å’ŒåŠ è½½
  - [ ] æ¨¡æ¿é€‰æ‹©
  - [ ] å¯¼å…¥å¯¼å‡º

- [ ] **æ‰§è¡Œæ§åˆ¶**
  - [ ] æ‰§è¡Œå·¥ä½œæµ
  - [ ] å®æ—¶çŠ¶æ€æ˜¾ç¤º
  - [ ] æš‚åœå’Œæ¢å¤
  - [ ] è°ƒè¯•æ¨¡å¼

- [ ] **ç”¨æˆ·ä½“éªŒ**
  - [ ] æ“ä½œæ’¤é”€é‡åš
  - [ ] æ™ºèƒ½æç¤º
  - [ ] é”™è¯¯å‹å¥½æç¤º
  - [ ] åŠ è½½çŠ¶æ€æ˜¾ç¤º

### âœ… é›†æˆæµ‹è¯•æ£€æŸ¥æ¸…å•

#### APIé›†æˆæµ‹è¯•

- [ ] **å‰åç«¯é€šä¿¡**
  - [ ] APIæ¥å£è¿é€šæ€§
  - [ ] æ•°æ®æ ¼å¼ä¸€è‡´æ€§
  - [ ] é”™è¯¯å¤„ç†ä¼ é€’
  - [ ] è¶…æ—¶å¤„ç†

- [ ] **å®æ—¶åŠŸèƒ½**
  - [ ] WebSocketè¿æ¥
  - [ ] çŠ¶æ€åŒæ­¥
  - [ ] æ–­çº¿é‡è¿
  - [ ] æ¶ˆæ¯é˜Ÿåˆ—

#### åŠŸèƒ½é›†æˆæµ‹è¯•

- [ ] **å·¥ä½œæµå®Œæ•´æµç¨‹**
  - [ ] åˆ›å»ºåˆ°æ‰§è¡Œå®Œæ•´æµç¨‹
  - [ ] å¤æ‚æ¡ä»¶åˆ†æ”¯æµ‹è¯•
  - [ ] é”™è¯¯æ¢å¤æµ‹è¯•
  - [ ] æ€§èƒ½å‹åŠ›æµ‹è¯•

- [ ] **è·¨æµè§ˆå™¨å…¼å®¹**
  - [ ] Chromeæµ‹è¯•
  - [ ] Firefoxæµ‹è¯•
  - [ ] Safariæµ‹è¯•
  - [ ] Edgeæµ‹è¯•

### âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

#### ç¯å¢ƒé…ç½®

- [ ] **å¼€å‘ç¯å¢ƒ**
  - [ ] æœ¬åœ°å¼€å‘serveré…ç½®
  - [ ] çƒ­é‡è½½åŠŸèƒ½
  - [ ] è°ƒè¯•å·¥å…·é…ç½®
  - [ ] æ—¥å¿—é…ç½®

- [ ] **ç”Ÿäº§ç¯å¢ƒ**
  - [ ] æ„å»ºä¼˜åŒ–é…ç½®
  - [ ] é™æ€èµ„æºCDN
  - [ ] ç¼“å­˜ç­–ç•¥
  - [ ] ç›‘æ§é…ç½®

#### æ–‡æ¡£å’Œç»´æŠ¤

- [ ] **ç”¨æˆ·æ–‡æ¡£**
  - [ ] å¿«é€Ÿå…¥é—¨æŒ‡å—
  - [ ] åŠŸèƒ½è¯´æ˜æ–‡æ¡£
  - [ ] APIæ–‡æ¡£
  - [ ] æ•…éšœæ’é™¤æŒ‡å—

- [ ] **å¼€å‘æ–‡æ¡£**
  - [ ] æ¶æ„è®¾è®¡æ–‡æ¡£
  - [ ] ä»£ç è§„èŒƒ
  - [ ] éƒ¨ç½²æŒ‡å—
  - [ ] ç»´æŠ¤æ‰‹å†Œ

### âœ… è´¨é‡ä¿è¯æ£€æŸ¥æ¸…å•

#### ä»£ç è´¨é‡

- [ ] **ä»£ç å®¡æŸ¥**
  - [ ] ä»£ç é£æ ¼ç»Ÿä¸€
  - [ ] å®‰å…¨æ¼æ´æ£€æŸ¥
  - [ ] æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥
  - [ ] å•å…ƒæµ‹è¯•è¦†ç›–

- [ ] **è‡ªåŠ¨åŒ–æµ‹è¯•**
  - [ ] å•å…ƒæµ‹è¯• (>80%è¦†ç›–ç‡)
  - [ ] é›†æˆæµ‹è¯•
  - [ ] ç«¯åˆ°ç«¯æµ‹è¯•
  - [ ] æ€§èƒ½å›å½’æµ‹è¯•

#### å®‰å…¨æ£€æŸ¥

- [ ] **å®‰å…¨è¯„ä¼°**
  - [ ] è¾“å…¥éªŒè¯å®‰å…¨
  - [ ] ä»£ç æ‰§è¡Œå®‰å…¨
  - [ ] APIå®‰å…¨é…ç½®
  - [ ] æ•°æ®ä¼ è¾“åŠ å¯†

- [ ] **æ¼æ´æ‰«æ**
  - [ ] ä¾èµ–åº“å®‰å…¨æ‰«æ
  - [ ] é™æ€ä»£ç å®‰å…¨åˆ†æ
  - [ ] åŠ¨æ€å®‰å…¨æµ‹è¯•
  - [ ] æ¸—é€æµ‹è¯•

### ğŸ“Š å®Œæˆåº¦è¿½è¸ª

#### å¼€å‘è¿›åº¦æŒ‡æ ‡

| é˜¶æ®µ | é¢„æœŸå®Œæˆåº¦ | å½“å‰å®Œæˆåº¦ | é£é™©ç­‰çº§ |
|------|------------|------------|----------|
| åç«¯æ ¸å¿ƒå¼•æ“ | 100% | 0% | ğŸŸ¢ ä½ |
| å‰ç«¯åŸºç¡€ç•Œé¢ | 100% | 0% | ğŸŸ¡ ä¸­ |
| APIé›†æˆ | 100% | 0% | ğŸŸ¢ ä½ |
| é«˜çº§åŠŸèƒ½ | 80% | 0% | ğŸŸ¡ ä¸­ |
| æ–‡æ¡£æµ‹è¯• | 100% | 0% | ğŸŸ¢ ä½ |

#### è´¨é‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å½“å‰å€¼ | çŠ¶æ€ |
|------|--------|--------|------|
| å•å…ƒæµ‹è¯•è¦†ç›–ç‡ | >80% | 0% | â³ å¾…å¼€å§‹ |
| APIå“åº”æ—¶é—´ | <200ms | - | â³ å¾…æµ‹è¯• |
| å‰ç«¯åŠ è½½æ—¶é—´ | <2s | - | â³ å¾…æµ‹è¯• |
| ç”¨æˆ·ä½“éªŒè¯„åˆ† | >4.5/5 | - | â³ å¾…è¯„ä¼° |

---

## ğŸ“š ç»“è¯­

è¿™ä»½å¼€å‘æŒ‡å—ä¸ºå¯è§†åŒ–å·¥ä½œæµç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æŠ€æœ¯è“å›¾ï¼Œä»æ¶æ„è®¾è®¡åˆ°å…·ä½“å®ç°ï¼Œä»å‰ç«¯ç•Œé¢åˆ°åç«¯APIï¼Œä»å¼€å‘è§„èŒƒåˆ°éƒ¨ç½²ç»´æŠ¤ï¼Œç¡®ä¿å¼€å‘å›¢é˜Ÿèƒ½å¤ŸæŒ‰ç…§æ¸…æ™°çš„è·¯çº¿å›¾é«˜æ•ˆåœ°æ„å»ºå‡ºé«˜è´¨é‡çš„ç³»ç»Ÿã€‚

### ğŸ¯ å…³é”®æˆåŠŸå› ç´ 

1. **ä¸¥æ ¼æŒ‰ç…§æ£€æŸ¥æ¸…å•æ‰§è¡Œ**ï¼Œç¡®ä¿æ¯ä¸ªç¯èŠ‚éƒ½ä¸é—æ¼
2. **å……åˆ†åˆ©ç”¨ç°æœ‰æ¡†æ¶èƒ½åŠ›**ï¼Œå‡å°‘é‡å¤å¼€å‘å·¥ä½œ
3. **æŒç»­çš„ä»£ç å®¡æŸ¥å’Œæµ‹è¯•**ï¼Œä¿è¯ä»£ç è´¨é‡
4. **åŠæ—¶çš„ç”¨æˆ·åé¦ˆæ”¶é›†**ï¼Œç¡®ä¿äº§å“æ»¡è¶³å®é™…éœ€æ±‚

### ğŸš€ é¢„æœŸæˆæœ

å®Œæˆåçš„å¯è§†åŒ–å·¥ä½œæµç³»ç»Ÿå°†æä¾›ï¼š
- ç›´è§‚æ˜“ç”¨çš„æ‹–æ‹½å¼å·¥ä½œæµç¼–è¾‘å™¨
- å¼ºå¤§çš„å¤šLLMååŒæ‰§è¡Œèƒ½åŠ›
- å®Œå–„çš„æ¡ä»¶åˆ†æ”¯å’Œé”™è¯¯å¤„ç†æœºåˆ¶
- å®æ—¶çš„æ‰§è¡Œç›‘æ§å’Œè°ƒè¯•åŠŸèƒ½
- ä¸°å¯Œçš„å·¥ä½œæµæ¨¡æ¿å’Œæ‰©å±•èƒ½åŠ›

è¿™å°†æ˜¾è‘—æå‡ModularFlow Frameworkçš„æ˜“ç”¨æ€§å’ŒåŠŸèƒ½å®Œæ•´æ€§ï¼Œä¸ºç”¨æˆ·æä¾›é›¶ä»£ç çš„AIå·¥ä½œæµç¼–æ’ä½“éªŒï¼

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**æœ€åæ›´æ–°ï¼š** 2025-01-17  
**ç»´æŠ¤å›¢é˜Ÿï¼š** ModularFlowå¼€å‘å›¢é˜Ÿ